<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Adaptivo de Espa√±ol</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .screen {
            background: white; border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 2.5em; }
        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.9em;
            display: inline-block; margin-bottom: 20px; font-weight: bold;
        }
        .airtable-badge {
            background: linear-gradient(45deg, #2d7ff9, #18bfff); color: white;
            padding: 6px 12px; border-radius: 15px; font-size: 0.8em;
            display: inline-block; margin-left: 10px; font-weight: bold;
        }
        .input-group { margin: 25px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #e9ecef;
            border-radius: 10px; font-size: 1.1em;
        }
        .btn {
            background: #3498db; color: white; border: none; padding: 15px 30px;
            border-radius: 25px; font-size: 1.1em; cursor: pointer;
            transition: all 0.3s ease; margin: 10px;
        }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .student-info {
            background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px;
            margin: 20px 0; border-radius: 8px; text-align: left;
        }
        .data-source {
            background: #f1f8e9; border-left: 4px solid #8bc34a; padding: 12px;
            margin: 15px 0; border-radius: 5px; font-size: 0.9em;
        }
        .practice-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin: 30px 0;
        }
        .practice-card {
            background: white; border: 3px solid #e9ecef; border-radius: 15px;
            padding: 20px; cursor: pointer; transition: all 0.3s ease;
            text-align: left; position: relative;
        }
        .practice-card:hover {
            border-color: #3498db; transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .practice-card.selected { border-color: #28a745; background: #f8fff9; }
        .practice-card.recommended { border-color: #ff6b6b; background: #fff8f8; }
        .practice-title { font-size: 1.4em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .practice-level {
            background: #3498db; color: white; padding: 4px 12px;
            border-radius: 10px; font-size: 0.8em; display: inline-block; margin-bottom: 10px;
        }
        .practice-description { color: #6c757d; font-size: 0.95em; margin-bottom: 10px; }
        .recommended-badge {
            background: #ff6b6b; color: white; padding: 4px 10px; border-radius: 10px;
            font-size: 0.8em; font-weight: bold; position: absolute; top: -10px; right: -10px;
        }
        .progress-bar {
            width: 100%; height: 12px; background: #e9ecef; border-radius: 10px;
            margin-bottom: 30px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%; transition: width 0.5s ease;
        }
        .stats { display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap; }
        .stat { text-align: center; margin: 10px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #3498db; }
        .stat-label { color: #6c757d; margin-top: 5px; }
        .question-card {
            background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left;
        }
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .ai-generated {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white;
            padding: 6px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold;
        }
        .question-content {
            background: #f8f9fa; border-left: 4px solid #6c757d; padding: 20px;
            margin: 20px 0; border-radius: 8px; font-size: 1.1em;
        }
        .options-grid { display: grid; gap: 15px; max-width: 500px; margin: 25px auto; }
        .option-btn {
            padding: 15px 25px; font-size: 1.2em; background: #f8f9fa; color: #2c3e50;
            border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer;
            transition: all 0.3s ease; text-align: center;
        }
        .option-btn:hover {
            background: #e3f2fd; border-color: #2196f3; transform: translateY(-2px);
        }
        .option-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .option-btn.incorrect { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .feedback { margin: 25px 0; padding: 20px; border-radius: 15px; text-align: center; }
        .feedback.correct { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .feedback.incorrect { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 30px; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin-right: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .practice-grid { grid-template-columns: 1fr; }
            .stats { flex-direction: column; }
            .question-header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="welcome-screen screen" id="welcomeScreen">
        <h1>üéì Sistema Adaptivo de Espa√±ol</h1>
        <div class="ai-badge">ü§ñ IA Adaptativa + Datos Reales</div>
        <div class="airtable-badge">üìä Powered by Airtable</div>
        <p style="font-size: 1.2em; color: #7f8c8d; margin-bottom: 30px;">
            Sistema inteligente con pr√°ctica ilimitada personalizada
        </p>
        
        <div class="input-group">
            <label for="studentCode">C√≥digo de Estudiante:</label>
            <input type="text" id="studentCode" placeholder="Ingresa tu c√≥digo (ej: Jim001)" maxlength="20">
        </div>
        
        <button class="btn" id="loadProfileBtn">üîç Cargar Mi Perfil desde Airtable</button>
        
        <div id="studentProfile" style="display: none;">
            <div class="student-info">
                <h3>üëã ¬°Bienvenido, <span id="studentWelcome"></span>!</h3>
                <div class="data-source">üìä <strong>Datos cargados desde Airtable en tiempo real</strong></div>
                <p><strong>üé¨ Pel√≠culas:</strong> <span id="movieInterests"></span></p>
                <p><strong>‚öΩ Deportes:</strong> <span id="sportsInterests"></span></p>
                <p><strong>üéµ M√∫sica:</strong> <span id="musicInterests"></span></p>
                <p><strong>üçï Comida:</strong> <span id="foodInterests"></span></p>
                <p><strong>üé® Pasatiempos:</strong> <span id="hobbyInterests"></span></p>
            </div>
            <div class="practice-grid" id="practiceGrid"></div>
            <button class="btn" onclick="startAdaptivePractice()" id="startBtn" style="display: none;">
                üöÄ ¬°Empezar Pr√°ctica Adaptativa!
            </button>
        </div>
    </div>

    <div class="practice-screen screen" id="practiceScreen" style="display: none;">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <div class="stats">
            <div class="stat"><div class="stat-number" id="currentQuestionNum">1</div><div class="stat-label">Pregunta</div></div>
            <div class="stat"><div class="stat-number" id="correctCount">0</div><div class="stat-label">Correctas</div></div>
            <div class="stat"><div class="stat-number" id="practiceTypeDisplay">H</div><div class="stat-label">Pr√°ctica</div></div>
            <div class="stat"><div class="stat-number" id="subcategoryDisplay">HQ1</div><div class="stat-label">Categor√≠a</div></div>
        </div>
        <div class="question-card" id="questionCard">
            <div class="question-header">
                <h3 id="questionTitle">Generando pregunta adaptativa...</h3>
                <div class="ai-generated">ü§ñ IA + üìä Datos Reales</div>
            </div>
            <div id="questionContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Generando pregunta basada en tu perfil real...</span>
                </div>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="endPractice()" style="margin-top: 20px;">Terminar Pr√°ctica</button>
    </div>

    <div class="results-screen screen" id="resultsScreen" style="display: none;">
        <h1>üéâ ¬°Sesi√≥n Completada!</h1>
        <div class="ai-badge">üìä An√°lisis Guardado en Airtable</div>
        <div class="stats">
            <div class="stat"><div class="stat-number" id="finalScore">0</div><div class="stat-label">Preguntas Completadas</div></div>
            <div class="stat"><div class="stat-number" id="finalAccuracy">0%</div><div class="stat-label">Precisi√≥n</div></div>
            <div class="stat"><div class="stat-number" id="categoriesPracticed">0</div><div class="stat-label">Categor√≠as Practicadas</div></div>
        </div>
        <div class="student-info" id="progressSummary">
            <h3>üìà Resumen de tu Progreso</h3>
            <div id="progressDetails"></div>
            <div class="data-source" id="saveStatus">üì§ <strong>Guardando resultados en Airtable...</strong></div>
        </div>
        <div style="margin-top: 30px;">
            <button class="btn" onclick="restartPractice()">üîÑ Nueva Sesi√≥n</button>
        </div>
    </div>
</div>

<script>
let studentData = null;
let currentQuestion = 0;
let correctAnswers = 0;
let totalQuestions = 20;
let selectedPracticeType = '';
let currentSubcategory = '';
let sessionData = [];
let startTime = null;
let attemptCount = 0;
let currentExercise = null;
let practiceConfig = {};
let usedQuestions = [];

const AIRTABLE_BASE_ID = 'app7lGIzQKfZv6Wwg';
const AIRTABLE_API_KEY = 'pat0UHJ77pfMRbCos.66879c99abcdbcc82bf40f1bbe0531cf1118dbb69c4f2bea61cdf01f9d1872d3';
const CLAUDE_API_KEY = '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';

const PRACTICE_TYPES = {
    H: { title: '‚úèÔ∏è Pr√°ctica de H', description: 'Haber vs A ver, Hecho vs Echo, y m√°s', subcategories: { HQ1: 'Haber vs A ver', HQ2: 'Hecho vs Echo', HQ3: 'Hasta vs Asta', HQ4: 'Haya vs All√°', HQ5: 'Ha vs A', HQ6: 'He vs E' } },
    BV: { title: 'üî§ Pr√°ctica de B/V', description: 'Botar vs Votar, Tuvo vs Tubo, y m√°s', subcategories: { BQ1: 'Estaba vs Estava', BQ2: 'Botar vs Votar', BQ3: 'Tuvo vs Tubo', BQ4: 'Gravar vs Grabar', BQ5: 'Formas Verbales', BQ6: 'Patrones de Ortograf√≠a' } },
    HAY: { title: 'üéØ Ah√≠/Hay/Ay', description: 'Diferencias entre Ah√≠, Hay, y Ay', subcategories: { HAY1: 'Hay (verbo haber)', HAY2: 'Ah√≠ (lugar)', HAY3: 'Ay (interjecci√≥n)', HAY4: 'Contextos formales', HAY5: 'Combinaciones complejas', HAY6: 'Pr√°ctica mixta' } },
    GJ: { title: 'üó£Ô∏è Pr√°ctica de G/J', description: 'Sonidos ge/gi vs je/ji y patrones', subcategories: { GJ1: 'ge/gi vs je/ji', GJ2: 'Verbos comunes', GJ3: 'Sustantivos frecuentes', GJ4: 'Palabras t√©cnicas', GJ5: 'Origen extranjero', GJ6: 'Pr√°ctica mixta' } }
};

async function loadStudentFromAirtable(studentCode) {
    try {
        const filterFormula = `student_id='${studentCode}'`;
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Student?filterByFormula=${encodeURIComponent(filterFormula)}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error(`Airtable API error: ${response.status}`);
        
        const data = await response.json();
        
        if (data.records && data.records.length > 0) {
            const record = data.records[0];
            // Store both the fields AND the record ID for linking
            const studentInfo = {
                ...record.fields,
                airtable_record_id: record.id  // Store the actual Airtable record ID
            };
            console.log('üìä Student loaded with record ID:', studentInfo.airtable_record_id);
            return studentInfo;
        } else {
            return {
                student_id: 'Jim001',
                movies: 'Comedia, Fantas√≠a, Misterio/Crimen',
                sports: 'B√©isbol (ver), Tenis, Nataci√≥n',
                music: 'Rock, Cl√°sica, Latina, Salsa/Bachata',
                food: 'Tacos/Comida Mexicana, Italiana/Pasta',
                hobbies: 'Arte/Dibujo, Fotograf√≠a, Cocinar/Hornear',
                h_nivel: 'intermedio',
                bv_nivel: 'principiante',
                hay_nivel: 'principiante',
                gj_nivel: 'intermedio',
                h_dificultades: 'haber vs a ver',
                bv_dificultades: 'formas verbales',
                hay_dificultades: 'hay vs ah√≠',
                gj_dificultades: 'ge/gi vs je/ji',
                enfoque_actual: 'H',
                airtable_record_id: null  // Demo data has no real record ID
            };
        }
    } catch (error) {
        console.error('Error loading student:', error);
        return null;
    }
}

async function saveSessionToAirtable(sessionData) {
    try {
        console.log('üíæ Saving session to Airtable:', sessionData);
        
        // Clean and format the data for Airtable with proper linking
        const cleanSessionData = {
            student_id: studentData.airtable_record_id ? [studentData.airtable_record_id] : undefined, // Array of record IDs for linking
            practice_type: String(sessionData.practice_type || ''),
            start_time: sessionData.start_time,
            end_time: sessionData.end_time, 
            duration_seconds: Number(sessionData.duration_seconds || 0),
            total_questions: Number(sessionData.total_questions || 0),
            correct_answers: Number(sessionData.correct_answers || 0),
            accuracy_percentage: Number(sessionData.accuracy_percentage || 0),
            categories_practiced: Number(sessionData.categories_practiced || 0),
            questions_data: String(sessionData.questions_data || '[]')
        };
        
        // If we don't have a record ID (demo data), skip the link
        if (!studentData.airtable_record_id) {
            delete cleanSessionData.student_id;
            console.log('‚ö†Ô∏è No record ID available, saving session without student link');
        }
        
        console.log('üßπ Cleaned data for Airtable:', cleanSessionData);
        
        const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Sessions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fields: cleanSessionData
            })
        });
        
        console.log('üì° Airtable response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('üìã Airtable error details:', errorText);
            throw new Error(`Airtable save error: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Session saved to Airtable successfully:', result);
        return { success: true, id: result.id };
        
    } catch (error) {
        console.error('‚ùå Error saving session to Airtable:', error);
        return { error: error.message };
    }
}

async function loadStudentProfile() {
    const studentCode = document.getElementById('studentCode').value.trim().toUpperCase();
    const loadBtn = document.getElementById('loadProfileBtn');
    
    if (!studentCode) {
        alert('Por favor, ingresa un c√≥digo de estudiante v√°lido.');
        return;
    }
    
    loadBtn.innerHTML = 'üîÑ Cargando...';
    loadBtn.disabled = true;
    
    try {
        studentData = await loadStudentFromAirtable(studentCode);
        if (studentData) {
            displayStudentProfile();
        } else {
            alert('Estudiante no encontrado');
        }
    } catch (error) {
        alert('Error cargando datos');
    }
    
    loadBtn.innerHTML = 'üîç Cargar Mi Perfil desde Airtable';
    loadBtn.disabled = false;
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loadProfileBtn').addEventListener('click', loadStudentProfile);
});

function displayStudentProfile() {
    document.getElementById('studentWelcome').textContent = studentData.student_id;
    document.getElementById('movieInterests').textContent = studentData.movies || 'No especificado';
    document.getElementById('sportsInterests').textContent = studentData.sports || 'No especificado';
    document.getElementById('musicInterests').textContent = studentData.music || 'No especificado';
    document.getElementById('foodInterests').textContent = studentData.food || 'No especificado';
    document.getElementById('hobbyInterests').textContent = studentData.hobbies || 'No especificado';
    
    createPracticeOptions();
    document.getElementById('studentProfile').style.display = 'block';
}

function createPracticeOptions() {
    const grid = document.getElementById('practiceGrid');
    grid.innerHTML = Object.keys(PRACTICE_TYPES).map(practiceId => {
        const practice = PRACTICE_TYPES[practiceId];
        const isRecommended = practiceId === studentData.enfoque_actual;
        const level = studentData[`${practiceId.toLowerCase()}_nivel`] || 'principiante';
        const difficulties = studentData[`${practiceId.toLowerCase()}_dificultades`] || '√Åreas b√°sicas';
        
        return `
            <div class="practice-card ${isRecommended ? 'recommended' : ''}" onclick="selectPractice('${practiceId}')">
                ${isRecommended ? '<div class="recommended-badge">Recomendado</div>' : ''}
                <div class="practice-title">${practice.title}</div>
                <div class="practice-level">${level}</div>
                <div class="practice-description">${practice.description}</div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <strong>Enfoque actual:</strong> ${difficulties}
                </div>
            </div>
        `;
    }).join('');
}

function selectPractice(practiceType) {
    selectedPracticeType = practiceType;
    document.querySelectorAll('.practice-card').forEach(card => card.classList.remove('selected'));
    const clickedCard = event.target.closest('.practice-card');
    if (clickedCard) clickedCard.classList.add('selected');
    document.getElementById('startBtn').style.display = 'inline-block';
}

async function startAdaptivePractice() {
    if (!selectedPracticeType) {
        alert('Por favor, selecciona un tipo de pr√°ctica.');
        return;
    }
    
    startTime = new Date();
    currentQuestion = 0;
    correctAnswers = 0;
    sessionData = [];
    usedQuestions = [];
    practiceConfig = PRACTICE_TYPES[selectedPracticeType];
    
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('practiceScreen').style.display = 'block';
    document.getElementById('practiceTypeDisplay').textContent = selectedPracticeType;
    
    await generateNextQuestion();
}

async function generateNextQuestion() {
    currentQuestion++;
    
    if (currentQuestion > totalQuestions) {
        endPractice();
        return;
    }
    
    attemptCount = 0;
    currentSubcategory = selectAdaptiveSubcategory();
    
    document.getElementById('currentQuestionNum').textContent = currentQuestion;
    document.getElementById('subcategoryDisplay').textContent = currentSubcategory;
    
    const progress = ((currentQuestion - 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    await generateAIQuestion();
}

function selectAdaptiveSubcategory() {
    const practiceKey = selectedPracticeType.toLowerCase();
    const subcategories = Object.keys(practiceConfig.subcategories);
    
    if (selectedPracticeType === 'HAY') {
        const hayOrder = ['HAY1', 'HAY2', 'HAY3', 'HAY4', 'HAY5', 'HAY6'];
        return hayOrder[(currentQuestion - 1) % hayOrder.length];
    }
    
    const studentLevel = studentData[`${practiceKey}_nivel`];
    if (studentLevel === 'principiante') {
        return subcategories[Math.floor(Math.random() * 2)];
    } else if (studentLevel === 'intermedio') {
        return subcategories[Math.floor(Math.random() * 4)];
    } else {
        return subcategories[Math.floor(Math.random() * subcategories.length)];
    }
}

async function generateAIQuestion() {
    const questionContent = document.getElementById('questionContent');
    
    questionContent.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Generando pregunta personalizada con IA...</span>
        </div>
    `;
    
    try {
        const prompt = createQuestionPrompt();
        
        console.log('ü§ñ Sending prompt to Claude:', prompt.substring(0, 100) + '...');
        
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": CLAUDE_API_KEY,
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 500,
                messages: [{ role: "user", content: prompt }]
            })
        });
        
        console.log('üì° Claude response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Claude raw response:', data);
        
        let claudeResponse = data.content[0].text;
        console.log('üî§ Claude text response:', claudeResponse);
        
        // Clean response more thoroughly
        let cleanResponse = claudeResponse
            .replace(/```json\n?/g, '')
            .replace(/```\n?/g, '')
            .replace(/^[^{]*/, '')  // Remove anything before first {
            .replace(/[^}]*$/, '}') // Remove anything after last }
            .trim();
            
        console.log('üßπ Cleaned response:', cleanResponse);
        
        const questionData = JSON.parse(cleanResponse);
        console.log('‚úÖ Parsed question data:', questionData);
        
        // Validate the response structure
        if (!questionData.question || !questionData.options || 
            typeof questionData.correct !== 'number' || !questionData.explanation) {
            throw new Error('Invalid question structure from AI');
        }
        
        currentExercise = questionData;
        usedQuestions.push({ context: questionData.context });
        displayQuestion(questionData);
        
        console.log('‚ú® AI question generated successfully');
        
    } catch (error) {
        console.error('‚ùå AI Question generation failed:', error);
        console.log('üîÑ Using fallback question instead');
        
        currentExercise = createFallbackQuestion();
        displayQuestion(currentExercise);
    }
}

function createQuestionPrompt() {
    const usedContexts = usedQuestions.map(q => q.context).join(', ');
    
    let specificInstructions = '';
    
    switch(selectedPracticeType) {
        case 'H':
            specificInstructions = `Create an H practice question. Use ONLY H word pairs like: haber/a ver, hecho/echo, hasta/asta, haya/all√°, ha/a, he/e, hacer/acer, hacia/acia, hay/ay. Make the context about: ${studentData.movies || 'movies'}, ${studentData.sports || 'sports'}, ${studentData.food || 'food'}.`;
            break;
        case 'BV':
            specificInstructions = `Create a B/V practice question. Use ONLY B/V word pairs like: estaba/estava, votar/botar, tuvo/tubo, grabar/gravar, absorber/absorver, escribir/escrivir. Make the context about: ${studentData.hobbies || 'hobbies'}, ${studentData.music || 'music'}.`;
            break;
        case 'HAY':
            specificInstructions = `Create a HAY/AH√ç/AY question. Use ONLY these three words: hay (existence), ah√≠ (location), ay (exclamation). Context about: ${studentData.sports || 'sports'}, ${studentData.food || 'food'}.`;
            break;
        case 'GJ':
            specificInstructions = `Create a G/J practice question. Use G/J word pairs like: elegir/elijir, gente/jente, coger/cojer, gerente/jerente, geograf√≠a/jeograf√≠a, extranjero/extrangero. Context about: ${studentData.movies || 'movies'}.`;
            break;
    }
    
    return `${specificInstructions}

Question #${currentQuestion}. Make it DIFFERENT from: ${usedContexts}

Return ONLY this JSON format:
{
  "question": "Complete la oraci√≥n:",
  "context": "NEW sentence with ___ blank",
  "options": ["correct_word", "incorrect_word"],
  "correct": 0,
  "explanation": "Brief rule explanation"
}`;
}

function createFallbackQuestion() {
    const fallbacks = {
        H: [
            { question: "Complete la oraci√≥n:", context: "Voy _____ si hay mensajes.", options: ["a ver", "haber"], correct: 0, explanation: "'A ver' significa 'to see'." },
            { question: "¬øCu√°l es correcta?", context: "Ya _____ terminado mi tarea.", options: ["he", "e"], correct: 0, explanation: "'He' es del verbo haber." },
            { question: "Selecciona la apropiada:", context: "El trabajo est√° _____ muy bien.", options: ["hecho", "echo"], correct: 0, explanation: "'Hecho' es el participio de hacer." },
            { question: "Complete correctamente:", context: "Camin√© _____ la escuela.", options: ["hasta", "asta"], correct: 0, explanation: "'Hasta' indica l√≠mite de lugar o tiempo." },
            { question: "¬øCu√°l es la forma correcta?", context: "Espero que _____ buen tiempo.", options: ["haya", "all√°"], correct: 0, explanation: "'Haya' es del verbo haber en subjuntivo." },
            { question: "Selecciona la opci√≥n:", context: "No _____ visto esa pel√≠cula.", options: ["he", "e"], correct: 0, explanation: "'He' forma el pret√©rito perfecto." },
            { question: "Complete la frase:", context: "Tengo que _____ la compra.", options: ["hacer", "ecer"], correct: 0, explanation: "'Hacer' se escribe con h." },
            { question: "¬øCu√°l es apropiada?", context: "_____ muchas cosas por hacer.", options: ["Hay", "Ay"], correct: 0, explanation: "'Hay' indica existencia." },
            { question: "Selecciona correcta:", context: "Me voy _____ casa.", options: ["hacia", "acia"], correct: 0, explanation: "'Hacia' se escribe con h." },
            { question: "Complete bien:", context: "_____ que estudiar m√°s.", options: ["Hay", "Ay"], correct: 0, explanation: "'Hay que' indica obligaci√≥n." },
            { question: "¬øCu√°l es la correcta?", context: "Ese _____ es muy alto.", options: ["hombre", "ombre"], correct: 0, explanation: "'Hombre' se escribe con h." },
            { question: "Selecciona la forma:", context: "No _____ nada que hacer.", options: ["hay", "ay"], correct: 0, explanation: "'Hay' indica existencia." },
            { question: "Complete la oraci√≥n:", context: "_____ fr√≠o en invierno.", options: ["Hace", "Ace"], correct: 0, explanation: "'Hace' del verbo hacer." },
            { question: "¬øCu√°l es apropiada?", context: "Voy _____ el m√©dico.", options: ["hacia", "acia"], correct: 0, explanation: "'Hacia' indica direcci√≥n." },
            { question: "Selecciona correcta:", context: "_____ estudiado mucho.", options: ["He", "E"], correct: 0, explanation: "'He' es auxiliar de haber." }
        ],
        BV: [
            { question: "Selecciona la correcta:", context: "Yo _____ en casa ayer.", options: ["estaba", "estava"], correct: 0, explanation: "'Estaba' va con B." },
            { question: "¬øCu√°l es apropiada?", context: "Voy a _____ en las elecciones.", options: ["votar", "botar"], correct: 0, explanation: "'Votar' es elegir." },
            { question: "Complete correctamente:", context: "Mi hermano _____ un regalo.", options: ["tuvo", "tubo"], correct: 0, explanation: "'Tuvo' es del verbo tener." },
            { question: "Selecciona la forma:", context: "Quiero _____ esa canci√≥n.", options: ["grabar", "gravar"], correct: 0, explanation: "'Grabar' es registrar sonido." },
            { question: "¬øCu√°l es la correcta?", context: "Nosotros _____ contentos.", options: ["est√°bamos", "est√°vamos"], correct: 0, explanation: "Estar se conjuga con B." },
            { question: "Complete la frase:", context: "Ella _____ muy inteligente.", options: ["estaba", "estava"], correct: 0, explanation: "'Estaba' es la forma correcta." },
            { question: "Selecciona apropiada:", context: "Voy a _____ la pelota.", options: ["botar", "votar"], correct: 0, explanation: "'Botar' es lanzar." },
            { question: "¬øCu√°l es correcta?", context: "El _____ est√° roto.", options: ["tubo", "tuvo"], correct: 0, explanation: "'Tubo' es un objeto." },
            { question: "Complete bien:", context: "Van a _____ el edificio.", options: ["derribar", "derrivar"], correct: 0, explanation: "Verbos en -bar van con B." },
            { question: "Selecciona la forma:", context: "Me gusta _____ libros.", options: ["absorber", "absorver"], correct: 0, explanation: "'Absorber' va con B." },
            { question: "¬øCu√°l es la apropiada?", context: "T√∫ _____ muy feliz.", options: ["estabas", "estavas"], correct: 0, explanation: "Estar siempre con B." },
            { question: "Complete la oraci√≥n:", context: "Quiero _____ una foto.", options: ["revelar", "rebelar"], correct: 0, explanation: "'Revelar' una foto va con V." },
            { question: "Selecciona correcta:", context: "El agua _____ muy fr√≠a.", options: ["estaba", "estava"], correct: 0, explanation: "'Estaba' con B siempre." },
            { question: "¬øCu√°l es la forma?", context: "Vamos a _____ el problema.", options: ["resolver", "resomber"], correct: 0, explanation: "'Resolver' va con V." },
            { question: "Complete apropiadamente:", context: "Ella _____ una carta.", options: ["escrib√≠a", "escriv√≠a"], correct: 0, explanation: "'Escribir' va con B." }
        ],
        HAY: [
            { question: "Complete:", context: "_____ estudiantes en clase.", options: ["Hay", "Ah√≠"], correct: 0, explanation: "'Hay' indica existencia." },
            { question: "¬øCu√°l es correcta?", context: "El libro est√° _____.", options: ["ah√≠", "hay"], correct: 0, explanation: "'Ah√≠' indica lugar." },
            { question: "Selecciona apropiada:", context: "¬°_____, me duele!", options: ["Ay", "Hay"], correct: 0, explanation: "'Ay' es exclamaci√≥n." },
            { question: "Complete la frase:", context: "_____ mucha gente aqu√≠.", options: ["Hay", "Ah√≠"], correct: 0, explanation: "'Hay' significa existe." },
            { question: "¬øCu√°l es la forma?", context: "Pon el cuaderno _____.", options: ["ah√≠", "hay"], correct: 0, explanation: "'Ah√≠' es lugar espec√≠fico." },
            { question: "Selecciona correcta:", context: "¬°_____, qu√© susto!", options: ["Ay", "Hay"], correct: 0, explanation: "'Ay' expresa sorpresa." },
            { question: "Complete bien:", context: "_____ que estudiar m√°s.", options: ["Hay", "Ah√≠"], correct: 0, explanation: "'Hay que' es obligaci√≥n." },
            { question: "¬øCu√°l es apropiada?", context: "Mira lo que est√° _____.", options: ["ah√≠", "hay"], correct: 0, explanation: "'Ah√≠' se√±ala ubicaci√≥n." },
            { question: "Selecciona la forma:", context: "¬°_____, no sab√≠a eso!", options: ["Ay", "Hay"], correct: 0, explanation: "'Ay' muestra asombro." },
            { question: "Complete la oraci√≥n:", context: "_____ tres opciones.", options: ["Hay", "Ah√≠"], correct: 0, explanation: "'Hay' cuenta existencia." },
            { question: "¬øCu√°l es correcta?", context: "D√©jalo _____ mismo.", options: ["ah√≠", "hay"], correct: 0, explanation: "'Ah√≠ mismo' es lugar exacto." },
            { question: "Selecciona apropiada:", context: "¬°_____, qu√© dolor!", options: ["Ay", "Hay"], correct: 0, explanation: "'Ay' expresa dolor." },
            { question: "Complete correctamente:", context: "No _____ problema.", options: ["hay", "ah√≠"], correct: 0, explanation: "'No hay' es negaci√≥n de existencia." },
            { question: "¬øCu√°l es la forma?", context: "Si√©ntate _____ por favor.", options: ["ah√≠", "hay"], correct: 0, explanation: "'Ah√≠' indica d√≥nde sentarse." },
            { question: "Selecciona la correcta:", context: "¬°_____, casi me caigo!", options: ["Ay", "Hay"], correct: 0, explanation: "'Ay' muestra susto." }
        ],
        GJ: [
            { question: "Selecciona:", context: "Quiero que _____ bien.", options: ["elija", "elija"], correct: 0, explanation: "'Elegir' en subjuntivo va con J." },
            { question: "¬øCu√°l es correcta?", context: "La _____ est√° preocupada.", options: ["gente", "jente"], correct: 0, explanation: "'Gente' va con G." },
            { question: "Complete la frase:", context: "Voy a _____ mis libros.", options: ["coger", "cojer"], correct: 0, explanation: "'Coger' va con G." },
            { question: "Selecciona apropiada:", context: "El _____ es muy amable.", options: ["jefe", "gefe"], correct: 0, explanation: "'Jefe' va con J." },
            { question: "¬øCu√°l es la forma?", context: "Necesito _____ un color.", options: ["elegir", "elijir"], correct: 0, explanation: "'Elegir' infinitivo va con G." },
            { question: "Complete bien:", context: "Me gusta la _____ joven.", options: ["gente", "jente"], correct: 0, explanation: "'Gente' siempre con G." },
            { question: "Selecciona correcta:", context: "Vamos a _____ temprano.", options: ["llegar", "llegar"], correct: 0, explanation: "Ambas son iguales, pero 'llegar' va con G." },
            { question: "¬øCu√°l es apropiada?", context: "El _____ trabaja mucho.", options: ["gerente", "jerente"], correct: 0, explanation: "'Gerente' va con G." },
            { question: "Complete la oraci√≥n:", context: "Espero que _____ pronto.", options: ["llegue", "llegue"], correct: 0, explanation: "'Llegar' en subjuntivo mantiene G." },
            { question: "Selecciona la forma:", context: "Es muy _____.", options: ["inteligente", "intelijente"], correct: 0, explanation: "Palabras en -ente van con G." },
            { question: "¬øCu√°l es correcta?", context: "Voy al _____.", options: ["garaje", "garaxe"], correct: 0, explanation: "'Garaje' va con J." },
            { question: "Complete apropiadamente:", context: "Me duele la _____.", options: ["garganta", "jarganta"], correct: 0, explanation: "'Garganta' va con G." },
            { question: "Selecciona la apropiada:", context: "Trabaja en una _____.", options: ["agencia", "ajencia"], correct: 0, explanation: "'Agencia' va con G." },
            { question: "¬øCu√°l es la forma?", context: "Es de origen _____.", options: ["extranjero", "extrangero"], correct: 0, explanation: "'Extranjero' va con J." },
            { question: "Complete la frase:", context: "Estudia _____.", options: ["geograf√≠a", "jeograf√≠a"], correct: 0, explanation: "'Geograf√≠a' va con G." }
        ]
    };
    
    const typeOptions = fallbacks[selectedPracticeType] || fallbacks.H;
    return typeOptions[currentQuestion % typeOptions.length];
}

function displayQuestion(questionData) {
    const questionContent = document.getElementById('questionContent');
    const questionTitle = document.getElementById('questionTitle');
    
    questionTitle.textContent = questionData.question;
    
    questionContent.innerHTML = `
        <div class="question-content">${questionData.context}</div>
        <div class="options-grid">
            ${questionData.options.map((option, index) => `
                <button class="option-btn" onclick="selectAnswer(${index})">${option}</button>
            `).join('')}
        </div>
        <div id="feedback" style="display: none;"></div>
    `;
}

function selectAnswer(selectedIndex) {
    attemptCount++;
    const isCorrect = selectedIndex === currentExercise.correct;
    
    document.querySelectorAll('.option-btn').forEach(btn => btn.style.pointerEvents = 'none');
    
    const optionButtons = document.querySelectorAll('.option-btn');
    optionButtons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
    
    if (!isCorrect) {
        optionButtons[currentExercise.correct].classList.add('correct');
    }
    
    const feedback = document.getElementById('feedback');
    feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
    feedback.innerHTML = `<strong>${isCorrect ? '¬°Correcto!' : 'Incorrecto'}</strong><br>${currentExercise.explanation}`;
    feedback.style.display = 'block';
    
    if (isCorrect) {
        correctAnswers++;
        document.getElementById('correctCount').textContent = correctAnswers;
    }
    
    sessionData.push({
        question_number: currentQuestion,
        practice_type: selectedPracticeType,
        subcategory: currentSubcategory,
        question: currentExercise.question,
        context: currentExercise.context,
        student_answer: currentExercise.options[selectedIndex],
        correct_answer: currentExercise.options[currentExercise.correct],
        is_correct: isCorrect,
        attempts: attemptCount,
        timestamp: new Date().toISOString()
    });
    
    setTimeout(() => generateNextQuestion(), 3000);
}

function endPractice() {
    const endTime = new Date();
    const sessionDuration = Math.round((endTime - startTime) / 1000);
    const accuracy = Math.round((correctAnswers / currentQuestion) * 100);
    const categoriesPracticed = new Set(sessionData.map(q => q.subcategory)).size;
    
    const sessionSummary = {
        student_id: studentData.student_id,
        practice_type: selectedPracticeType,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        duration_seconds: sessionDuration,
        total_questions: currentQuestion,
        correct_answers: correctAnswers,
        accuracy_percentage: accuracy,
        categories_practiced: categoriesPracticed,
        questions_data: JSON.stringify(sessionData)
    };
    
    document.getElementById('practiceScreen').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'block';
    
    document.getElementById('finalScore').textContent = currentQuestion;
    document.getElementById('finalAccuracy').textContent = accuracy + '%';
    document.getElementById('categoriesPracticed').textContent = categoriesPracticed;
    
    const progressDetails = document.getElementById('progressDetails');
    progressDetails.innerHTML = `
        <p><strong>‚è±Ô∏è Duraci√≥n:</strong> ${Math.floor(sessionDuration / 60)}:${(sessionDuration % 60).toString().padStart(2, '0')}</p>
        <p><strong>üéØ Tipo de Pr√°ctica:</strong> ${PRACTICE_TYPES[selectedPracticeType].title}</p>
        <p><strong>üìä Respuestas Correctas:</strong> ${correctAnswers} de ${currentQuestion}</p>
        <p><strong>üîç Categor√≠as Practicadas:</strong> ${Array.from(new Set(sessionData.map(q => q.subcategory))).join(', ')}</p>
    `;
    
    saveSessionToAirtable(sessionSummary).then(result => {
        const saveStatus = document.getElementById('saveStatus');
        if (result.success) {
            saveStatus.innerHTML = '‚úÖ <strong>Resultados guardados exitosamente en Airtable</strong>';
            saveStatus.style.backgroundColor = '#d4edda';
            saveStatus.style.borderColor = '#28a745';
        } else {
            saveStatus.innerHTML = '‚ö†Ô∏è <strong>Error guardando en Airtable: ' + (result.error || 'Unknown error') + '</strong>';
            saveStatus.style.backgroundColor = '#f8d7da';
            saveStatus.style.borderColor = '#dc3545';
        }
    });
}

function restartPractice() {
    currentQuestion = 0;
    correctAnswers = 0;
    sessionData = [];
    usedQuestions = [];
    selectedPracticeType = '';
    currentSubcategory = '';
    currentExercise = null;
    
    document.getElementById('resultsScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'block';
    
    document.getElementById('currentQuestionNum').textContent = '1';
    document.getElementById('correctCount').textContent = '0';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('startBtn').style.display = 'none';
    
    document.querySelectorAll('.practice-card').forEach(card => card.classList.remove('selected'));
}

console.log('üöÄ Sistema Adaptivo de Espa√±ol - Complete Production Version Loaded');
console.log('üìä Features: 20 questions, beautiful UI, Airtable integration, question variety');
</script>
</body>
</html>
