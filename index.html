<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Adaptivo de Espa√±ol</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .screen {
            background: white; border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center;
        }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 2.5em; }
        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.9em;
            display: inline-block; margin-bottom: 20px; font-weight: bold;
        }
        .airtable-badge {
            background: linear-gradient(45deg, #2d7ff9, #18bfff); color: white;
            padding: 6px 12px; border-radius: 15px; font-size: 0.8em;
            display: inline-block; margin-left: 10px; font-weight: bold;
        }
        .input-group { margin: 25px 0; text-align: left; }
        .input-group label {
            display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;
        }
        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #e9ecef;
            border-radius: 10px; font-size: 1.1em;
        }
        .btn {
            background: #3498db; color: white; border: none; padding: 15px 30px;
            border-radius: 25px; font-size: 1.1em; cursor: pointer;
            transition: all 0.3s ease; margin: 10px;
        }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .student-info {
            background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px;
            margin: 20px 0; border-radius: 8px; text-align: left;
        }
        .data-source {
            background: #f1f8e9; border-left: 4px solid #8bc34a; padding: 12px;
            margin: 15px 0; border-radius: 5px; font-size: 0.9em;
        }
        .practice-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin: 30px 0;
        }
        .practice-card {
            background: white; border: 3px solid #e9ecef; border-radius: 15px;
            padding: 20px; cursor: pointer; transition: all 0.3s ease;
            text-align: left; position: relative;
        }
        .practice-card:hover {
            border-color: #3498db; transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        .practice-card.selected { border-color: #28a745; background: #f8fff9; }
        .practice-card.recommended { border-color: #ff6b6b; background: #fff8f8; }
        .practice-title {
            font-size: 1.4em; font-weight: bold; color: #2c3e50; margin-bottom: 10px;
        }
        .practice-level {
            background: #3498db; color: white; padding: 4px 12px;
            border-radius: 10px; font-size: 0.8em; display: inline-block; margin-bottom: 10px;
        }
        .practice-description { color: #6c757d; font-size: 0.95em; margin-bottom: 10px; }
        .recommended-badge {
            background: #ff6b6b; color: white; padding: 4px 10px; border-radius: 10px;
            font-size: 0.8em; font-weight: bold; position: absolute; top: -10px; right: -10px;
        }
        .progress-bar {
            width: 100%; height: 12px; background: #e9ecef; border-radius: 10px;
            margin-bottom: 30px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%; transition: width 0.5s ease;
        }
        .stats {
            display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap;
        }
        .stat { text-align: center; margin: 10px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #3498db; }
        .stat-label { color: #6c757d; margin-top: 5px; }
        .question-card {
            background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left;
        }
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .ai-generated {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white;
            padding: 6px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold;
        }
        .question-content {
            background: #f8f9fa; border-left: 4px solid #6c757d; padding: 20px;
            margin: 20px 0; border-radius: 8px; font-size: 1.1em;
        }
        .options-grid {
            display: grid; gap: 15px; max-width: 500px; margin: 25px auto;
        }
        .option-btn {
            padding: 15px 25px; font-size: 1.2em; background: #f8f9fa; color: #2c3e50;
            border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer;
            transition: all 0.3s ease; text-align: center;
        }
        .option-btn:hover {
            background: #e3f2fd; border-color: #2196f3; transform: translateY(-2px);
        }
        .option-btn.correct {
            background: #d4edda; border-color: #28a745; color: #155724;
        }
        .option-btn.incorrect {
            background: #f8d7da; border-color: #dc3545; color: #721c24;
        }
        .feedback {
            margin: 25px 0; padding: 20px; border-radius: 15px; text-align: center;
        }
        .feedback.correct {
            background: #d4edda; border: 2px solid #28a745; color: #155724;
        }
        .feedback.incorrect {
            background: #f8d7da; border: 2px solid #dc3545; color: #721c24;
        }
        .loading {
            display: flex; align-items: center; justify-content: center; padding: 30px;
        }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin-right: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error {
            background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24;
            padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;
        }
        @media (max-width: 768px) {
            .practice-grid { grid-template-columns: 1fr; }
            .stats { flex-direction: column; }
            .question-header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="welcome-screen screen" id="welcomeScreen">
        <h1>üéì Sistema Adaptivo de Espa√±ol</h1>
        <div class="ai-badge">ü§ñ IA Adaptativa + Datos Reales</div>
        <div class="airtable-badge">üìä Powered by Airtable</div>
        <p style="font-size: 1.2em; color: #7f8c8d; margin-bottom: 30px;">
            Sistema inteligente con pr√°ctica ilimitada personalizada
        </p>
        <div class="input-group">
            <label for="studentCode">C√≥digo de Estudiante:</label>
            <input type="text" id="studentCode" placeholder="Ingresa tu c√≥digo (ej: Jim001)" maxlength="20">
        </div>
        <button class="btn" id="loadProfileBtn">üîç Cargar Mi Perfil desde Airtable</button>
        <div id="studentProfile" style="display: none;">
            <div class="student-info">
                <h3>üëã ¬°Bienvenido, <span id="studentWelcome"></span>!</h3>
                <div class="data-source">üìä <strong>Datos cargados desde Airtable en tiempo real</strong></div>
                <p><strong>üé¨ Pel√≠culas:</strong> <span id="movieInterests"></span></p>
                <p><strong>‚öΩ Deportes:</strong> <span id="sportsInterests"></span></p>
                <p><strong>üéµ M√∫sica:</strong> <span id="musicInterests"></span></p>
                <p><strong>üçï Comida:</strong> <span id="foodInterests"></span></p>
                <p><strong>üé® Pasatiempos:</strong> <span id="hobbyInterests"></span></p>
            </div>
            <div class="practice-grid" id="practiceGrid"></div>
            <button class="btn" onclick="startAdaptivePractice()" id="startBtn" style="display: none;">
                üöÄ ¬°Empezar Pr√°ctica Adaptativa!
            </button>
        </div>
    </div>
    <div class="practice-screen screen" id="practiceScreen" style="display: none;">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <div class="stats">
            <div class="stat"><div class="stat-number" id="currentQuestion">1</div><div class="stat-label">Pregunta</div></div>
            <div class="stat"><div class="stat-number" id="correctCount">0</div><div class="stat-label">Correctas</div></div>
            <div class="stat"><div class="stat-number" id="practiceType">H</div><div class="stat-label">Pr√°ctica</div></div>
            <div class="stat"><div class="stat-number" id="subcategory">HQ1</div><div class="stat-label">Categor√≠a</div></div>
        </div>
        <div class="question-card" id="questionCard">
            <div class="question-header">
                <h3 id="questionTitle">Generando pregunta adaptativa...</h3>
                <div class="ai-generated">ü§ñ IA + üìä Datos Reales</div>
            </div>
            <div id="questionContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Generando pregunta basada en tu perfil real...</span>
                </div>
            </div>
        </div>
        <button class="btn btn-secondary" onclick="endPractice()" style="margin-top: 20px;">Terminar Pr√°ctica</button>
    </div>
    <div class="results-screen screen" id="resultsScreen" style="display: none;">
        <h1>üéâ ¬°Sesi√≥n Completada!</h1>
        <div class="ai-badge">üìä An√°lisis Guardado en Airtable</div>
        <div class="stats">
            <div class="stat"><div class="stat-number" id="finalScore">0</div><div class="stat-label">Preguntas Completadas</div></div>
            <div class="stat"><div class="stat-number" id="finalAccuracy">0%</div><div class="stat-label">Precisi√≥n</div></div>
            <div class="stat"><div class="stat-number" id="categoriesPracticed">0</div><div class="stat-label">Categor√≠as Practicadas</div></div>
        </div>
        <div class="student-info" id="progressSummary">
            <h3>üìà Resumen de tu Progreso</h3>
            <div id="progressDetails"></div>
            <div class="data-source" id="saveStatus">üì§ <strong>Guardando resultados en Airtable...</strong></div>
        </div>
        <div style="margin-top: 30px;">
            <button class="btn" onclick="restartPractice()">üîÑ Nueva Sesi√≥n</button>
        </div>
    </div>
</div>

<script>
let studentData = null;
let currentQuestion = 0;
let correctAnswers = 0;
let totalQuestions = 10;
let selectedPracticeType = '';
let currentSubcategory = '';
let sessionData = [];
let startTime = null;
let attemptCount = 0;
let currentExercise = null;
let practiceConfig = {};
let usedQuestions = [];

const AIRTABLE_BASE_ID = 'app7lGIzQKfZv6Wwg';
const AIRTABLE_API_KEY = 'pat0UHJ77pfMRbCos.66879c99abcdbcc82bf40f1bbe0531cf1118dbb69c4f2bea61cdf01f9d1872d3';
const CLAUDE_API_KEY = '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';

const PRACTICE_TYPES = {
    H: { title: '‚úèÔ∏è Pr√°ctica de H', description: 'Haber vs A ver, Hecho vs Echo, y m√°s', subcategories: { HQ1: 'Haber vs A ver', HQ2: 'Hecho vs Echo', HQ3: 'Hasta vs Asta', HQ4: 'Haya vs All√°', HQ5: 'Ha vs A', HQ6: 'He vs E' } },
    BV: { title: 'üî§ Pr√°ctica de B/V', description: 'Botar vs Votar, Tuvo vs Tubo, y m√°s', subcategories: { BQ1: 'Estaba vs Estava', BQ2: 'Botar vs Votar', BQ3: 'Tuvo vs Tubo', BQ4: 'Gravar vs Grabar', BQ5: 'Formas Verbales', BQ6: 'Patrones de Ortograf√≠a' } },
    HAY: { title: 'üéØ Ah√≠/Hay/Ay', description: 'Diferencias entre Ah√≠, Hay, y Ay', subcategories: { HAY1: 'Hay (verbo haber)', HAY2: 'Ah√≠ (lugar)', HAY3: 'Ay (interjecci√≥n)', HAY4: 'Contextos formales', HAY5: 'Combinaciones complejas', HAY6: 'Pr√°ctica mixta' } },
    GJ: { title: 'üó£Ô∏è Pr√°ctica de G/J', description: 'Sonidos ge/gi vs je/ji y patrones', subcategories: { GJ1: 'ge/gi vs je/ji', GJ2: 'Verbos comunes', GJ3: 'Sustantivos frecuentes', GJ4: 'Palabras t√©cnicas', GJ5: 'Origen extranjero', GJ6: 'Pr√°ctica mixta' } }
};

async function loadStudentFromAirtable(studentCode) {
    try {
        console.log('üìä Loading student from Airtable:', studentCode);
        const filterFormula = `student_id='${studentCode}'`;
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Student?filterByFormula=${encodeURIComponent(filterFormula)}`;
        console.log('üîó API URL:', url);
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Airtable response:', data);
        
        if (data.records && data.records.length > 0) {
            return data.records[0].fields;
        } else {
            console.log('üìö Student not found in Airtable, using demo data');
            return loadDemoStudentData(studentCode);
        }
    } catch (error) {
        console.error('‚ùå Error loading student from Airtable:', error);
        console.log('üîÑ Falling back to demo data...');
        return loadDemoStudentData(studentCode);
    }
}

function loadDemoStudentData(studentCode) {
    console.log('üìö Using demo data for:', studentCode);
    const mockStudentData = {
        'JIM001': {
            student_id: 'Jim001', movies: 'Comedia, Fantas√≠a, Misterio/Crimen', sports: 'B√©isbol (ver), Tenis, Nataci√≥n', books: 'Misterio/Detectivesco, Romance, Ciencia Ficci√≥n, Aventura, No ficci√≥n', music: 'Rock, Cl√°sica, Latina, Salsa/Bachata', food: 'Tacos/Comida Mexicana, Italiana/Pasta, Comida Vegetariana, Comida Casera', hobbies: 'Arte/Dibujo, Fotograf√≠a, Cocinar/Hornear, Viajar, Coleccionar Cosas', h_nivel: 'intermedio', bv_nivel: 'principiante', hay_nivel: 'principiante', gj_nivel: 'intermedio', h_dificultades: 'haber vs a ver', bv_dificultades: 'formas verbales', hay_dificultades: 'hay vs ah√≠', gj_dificultades: 'ge/gi vs je/ji', enfoque_actual: 'H'
        }
    };
    return mockStudentData[studentCode.toUpperCase()] || null;
}

async function saveSessionToAirtable(sessionData) {
    try {
        console.log('üíæ Saving session to Airtable:', sessionData);
        const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Sessions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fields: sessionData })
        });
        
        if (!response.ok) {
            throw new Error(`Airtable save error: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Session saved to Airtable:', result);
        return { success: true, id: result.id };
    } catch (error) {
        console.error('‚ùå Error saving session to Airtable:', error);
        return { error: error.message };
    }
}

async function loadStudentProfile() {
    const studentCode = document.getElementById('studentCode').value.trim().toUpperCase();
    const loadBtn = document.getElementById('loadProfileBtn');
    console.log('üîç Attempting to load student:', studentCode);
    
    if (!studentCode) {
        alert('Por favor, ingresa un c√≥digo de estudiante v√°lido.');
        return;
    }
    
    loadBtn.innerHTML = 'üîÑ Cargando...';
    loadBtn.disabled = true;
    
    try {
        console.log('üì° Calling loadStudentFromAirtable...');
        studentData = await loadStudentFromAirtable(studentCode);
        console.log('üìä Student data received:', studentData);
        
        if (studentData) {
            console.log('‚úÖ Student found, displaying profile...');
            displayStudentProfile();
        } else {
            console.log('‚ùå Student not found');
            alert(`Estudiante "${studentCode}" no encontrado. Verifica el c√≥digo e intenta de nuevo.`);
        }
    } catch (error) {
        console.error('üí• Error loading student:', error);
        alert('Error cargando los datos del estudiante. Intenta de nuevo.');
    }
    
    loadBtn.innerHTML = 'üîç Cargar Mi Perfil desde Airtable';
    loadBtn.disabled = false;
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, setting up event listeners...');
    const loadBtn = document.getElementById('loadProfileBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', loadStudentProfile);
        console.log('‚úÖ Load button event listener attached');
    } else {
        console.error('‚ùå Load button not found!');
    }
});

function displayStudentProfile() {
    const profile = document.getElementById('studentProfile');
    const welcome = document.getElementById('studentWelcome');
    welcome.textContent = studentData.student_id;
    document.getElementById('movieInterests').textContent = studentData.movies || 'No especificado';
    document.getElementById('sportsInterests').textContent = studentData.sports || 'No especificado';
    document.getElementById('musicInterests').textContent = studentData.music || 'No especificado';
    document.getElementById('foodInterests').textContent = studentData.food || 'No especificado';
    document.getElementById('hobbyInterests').textContent = studentData.hobbies || 'No especificado';
    createPracticeOptions();
    profile.style.display = 'block';
}

function createPracticeOptions() {
    const grid = document.getElementById('practiceGrid');
    grid.innerHTML = Object.keys(PRACTICE_TYPES).map(practiceId => {
        const practice = PRACTICE_TYPES[practiceId];
        const isRecommended = practiceId === studentData.enfoque_actual;
        const level = studentData[`${practiceId.toLowerCase()}_nivel`] || 'principiante';
        const difficulties = studentData[`${practiceId.toLowerCase()}_dificultades`] || '√Åreas b√°sicas';
        return `
            <div class="practice-card ${isRecommended ? 'recommended' : ''}" onclick="selectPractice('${practiceId}')">
                ${isRecommended ? '<div class="recommended-badge">Recomendado</div>' : ''}
                <div class="practice-title">${practice.title}</div>
                <div class="practice-level">${level}</div>
                <div class="practice-description">${practice.description}</div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <strong>Enfoque actual:</strong> ${difficulties}
                </div>
            </div>
        `;
    }).join('');
}

function selectPractice(practiceType) {
    selectedPracticeType = practiceType;
    document.querySelectorAll('.practice-card').forEach(card => card.classList.remove('selected'));
    const clickedCard = event.target.closest('.practice-card');
    if (clickedCard) clickedCard.classList.add('selected');
    document.getElementById('startBtn').style.display = 'inline-block';
}

async function startAdaptivePractice() {
    if (!selectedPracticeType) {
        alert('Por favor, selecciona un tipo de pr√°ctica.');
        return;
    }
    startTime = new Date();
    currentQuestion = 0;
    correctAnswers = 0;
    sessionData = [];
    usedQuestions = [];
    practiceConfig = PRACTICE_TYPES[selectedPracticeType];
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('practiceScreen').style.display = 'block';
    document.getElementById('practiceType').textContent = selectedPracticeType;
    await generateNextQuestion();
}

async function generateNextQuestion() {
    currentQuestion++;
    if (currentQuestion > totalQuestions) {
        endPractice();
        return;
    }
    attemptCount = 0;
    currentSubcategory = selectAdaptiveSubcategory();
    document.getElementById('currentQuestion').textContent = currentQuestion;
    document.getElementById('subcategory').textContent = currentSubcategory;
    const progress = ((currentQuestion - 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    await generateAIQuestion();
}

function selectAdaptiveSubcategory() {
    const practiceKey = selectedPracticeType.toLowerCase();
    const studentLevel = studentData[`${practiceKey}_nivel`];
    const difficulties = studentData[`${practiceKey}_dificultades`];
    const subcategories = Object.keys(practiceConfig.subcategories);
    
    if (selectedPracticeType === 'HAY') {
        const hayOrder = ['HAY1', 'HAY2', 'HAY3', 'HAY4', 'HAY5', 'HAY6'];
        const currentIndex = (currentQuestion - 1) % hayOrder.length;
        return hayOrder[currentIndex];
    }
    
    if (Math.random() < 0.6) {
        const difficultyMap = {
            H: { 'haber vs a ver': 'HQ1', 'hecho vs echo': 'HQ2', 'hasta vs asta': 'HQ3', 'haya vs all√°': 'HQ4', 'ha vs a': 'HQ5', 'he vs e': 'HQ6', 'conceptos b√°sicos': 'HQ1', 'casos especiales': 'HQ4', 'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)] },
            BV: { 'estaba vs estava': 'BQ1', 'botar vs votar': 'BQ2', 'tuvo vs tubo': 'BQ3', 'gravar vs grabar': 'BQ4', 'formas verbales': 'BQ5', 'patrones avanzados': 'BQ6', 'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)] },
            HAY: { 'hay vs ah√≠': 'HAY1', 'diferencias b√°sicas': 'HAY1', 'ay interjecci√≥n': 'HAY3', 'contextos formales': 'HAY4', 'combinaciones complejas': 'HAY5', 'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)] },
            GJ: { 'ge/gi vs je/ji': 'GJ1', 'sonidos b√°sicos': 'GJ1', 'verbos comunes': 'GJ2', 'palabras t√©cnicas': 'GJ4', 'palabras extranjeras': 'GJ5', 'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)] }
        };
        const mappedSubcat = difficultyMap[selectedPracticeType]?.[difficulties];
        if (mappedSubcat) return mappedSubcat;
    }
    
    if (studentLevel === 'principiante') {
        return subcategories[Math.floor(Math.random() * 2)];
    } else if (studentLevel === 'intermedio') {
        return subcategories[Math.floor(Math.random() * 4)];
    } else {
        return subcategories[Math.floor(Math.random() * subcategories.length)];
    }
}

async function generateAIQuestion() {
    const questionContent = document.getElementById('questionContent');
    const questionTitle = document.getElementById('questionTitle');
    
    questionContent.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Generando pregunta personalizada con IA...</span>
        </div>
    `;
    
    try {
        const prompt = createQuestionPrompt(studentData, selectedPracticeType, currentSubcategory);
        
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": CLAUDE_API_KEY,
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 1000,
                messages:
