<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Adaptivo de Espa√±ol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .airtable-badge {
            background: linear-gradient(45deg, #2d7ff9, #18bfff);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
        }

        .input-group {
            margin: 25px 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .student-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: left;
        }

        .data-source {
            background: #f1f8e9;
            border-left: 4px solid #8bc34a;
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .practice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .practice-card {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
        }

        .practice-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .practice-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }

        .practice-card.recommended {
            border-color: #ff6b6b;
            background: #fff8f8;
        }

        .practice-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .practice-level {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 10px;
        }

        .practice-description {
            color: #6c757d;
            font-size: 0.95em;
            margin-bottom: 10px;
        }

        .recommended-badge {
            background: #ff6b6b;
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            position: absolute;
            top: -10px;
            right: -10px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            margin: 10px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: left;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ai-generated {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .question-content {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 1.1em;
        }

        .options-grid {
            display: grid;
            gap: 15px;
            max-width: 500px;
            margin: 25px auto;
        }

        .option-btn {
            padding: 15px 25px;
            font-size: 1.2em;
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .option-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
        }

        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .feedback {
            margin: 25px 0;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .feedback.correct {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .feedback.incorrect {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .practice-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .question-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Welcome Screen -->
    <div class="welcome-screen screen" id="welcomeScreen">
        <h1>üéì Sistema Adaptivo de Espa√±ol</h1>
        <div class="ai-badge">ü§ñ IA Adaptativa + Datos Reales</div>
        <div class="airtable-badge">üìä Powered by Airtable</div>
        <p style="font-size: 1.2em; color: #7f8c8d; margin-bottom: 30px;">
            Sistema inteligente con pr√°ctica ilimitada personalizada
        </p>

        <!-- Configuration Section -->
        <div class="config-section" id="configSection">
            <h3>üîß Configuraci√≥n de API</h3>
            <p style="color: #856404; margin-bottom: 15px;">
                Ingresa tus credenciales de Airtable:
            </p>
            <input type="text" class="config-input" id="airtableBaseId" placeholder="Airtable Base ID (app...)" value="">
            <input type="password" class="config-input" id="airtableApiKey" placeholder="Airtable API Key (pat...)" value="">
            <small style="color: #856404;">
                üí° Estas credenciales se guardar√°n temporalmente en tu navegador para esta sesi√≥n
            </small>
        </div>
        
        <div class="input-group">
            <label for="studentCode">C√≥digo de Estudiante:</label>
            <input type="text" id="studentCode" placeholder="Ingresa tu c√≥digo (ej: Jim001)" maxlength="20">
        </div>
        
        <button class="btn" id="loadProfileBtn">üîç Cargar Mi Perfil desde Airtable</button>
        
        <div id="studentProfile" style="display: none;">
            <div class="student-info">
                <h3>üëã ¬°Bienvenido, <span id="studentWelcome"></span>!</h3>
                <div class="data-source">
                    üìä <strong>Datos cargados desde Airtable en tiempo real</strong>
                </div>
                <p><strong>üé¨ Pel√≠culas:</strong> <span id="movieInterests"></span></p>
                <p><strong>‚öΩ Deportes:</strong> <span id="sportsInterests"></span></p>
                <p><strong>üéµ M√∫sica:</strong> <span id="musicInterests"></span></p>
                <p><strong>üçï Comida:</strong> <span id="foodInterests"></span></p>
                <p><strong>üé® Pasatiempos:</strong> <span id="hobbyInterests"></span></p>
            </div>
            
            <div class="practice-grid" id="practiceGrid">
                <!-- Practice options will be populated here -->
            </div>
            
            <button class="btn" onclick="startAdaptivePractice()" id="startBtn" style="display: none;">
                üöÄ ¬°Empezar Pr√°ctica Adaptativa!
            </button>
        </div>
    </div>

    <!-- Practice Screen -->
    <div class="practice-screen screen" id="practiceScreen" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="currentQuestion">1</div>
                <div class="stat-label">Pregunta</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="correctCount">0</div>
                <div class="stat-label">Correctas</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="practiceType">H</div>
                <div class="stat-label">Pr√°ctica</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="subcategory">HQ1</div>
                <div class="stat-label">Categor√≠a</div>
            </div>
        </div>

        <div class="question-card" id="questionCard">
            <div class="question-header">
                <h3 id="questionTitle">Generando pregunta adaptativa...</h3>
                <div class="ai-generated">ü§ñ IA + üìä Datos Reales</div>
            </div>
            
            <div id="questionContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Generando pregunta basada en tu perfil real...</span>
                </div>
            </div>
        </div>

        <button class="btn btn-secondary" onclick="endPractice()" style="margin-top: 20px;">
            Terminar Pr√°ctica
        </button>
    </div>

    <!-- Results Screen -->
    <div class="results-screen screen" id="resultsScreen" style="display: none;">
        <h1>üéâ ¬°Sesi√≥n Completada!</h1>
        <div class="ai-badge">üìä An√°lisis Guardado en Airtable</div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="finalScore">0</div>
                <div class="stat-label">Preguntas Completadas</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="finalAccuracy">0%</div>
                <div class="stat-label">Precisi√≥n</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="categoriesPracticed">0</div>
                <div class="stat-label">Categor√≠as Practicadas</div>
            </div>
        </div>
        
        <div class="student-info" id="progressSummary">
            <h3>üìà Resumen de tu Progreso</h3>
            <div id="progressDetails"></div>
            <div class="data-source" id="saveStatus">
                üì§ <strong>Guardando resultados en Airtable...</strong>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn" onclick="restartPractice()">üîÑ Nueva Sesi√≥n</button>
        </div>
    </div>
</div>

<script>
// ==================== GLOBAL VARIABLES ====================
let studentData = null;
let currentQuestion = 0;
let correctAnswers = 0;
let totalQuestions = 10;
let selectedPracticeType = '';
let currentSubcategory = '';
let sessionData = [];
let startTime = null;
let attemptCount = 0;
let currentExercise = null;
let practiceConfig = {};

// Practice configurations (from your existing system)
const PRACTICE_TYPES = {
    H: {
        title: '‚úèÔ∏è Pr√°ctica de H',
        description: 'Haber vs A ver, Hecho vs Echo, y m√°s',
        subcategories: {
            HQ1: 'Haber vs A ver',
            HQ2: 'Hecho vs Echo', 
            HQ3: 'Hasta vs Asta',
            HQ4: 'Haya vs All√°',
            HQ5: 'Ha vs A',
            HQ6: 'He vs E'
        }
    },
    BV: {
        title: 'üî§ Pr√°ctica de B/V',
        description: 'Botar vs Votar, Tuvo vs Tubo, y m√°s',
        subcategories: {
            BQ1: 'Estaba vs Estava',
            BQ2: 'Botar vs Votar',
            BQ3: 'Tuvo vs Tubo',
            BQ4: 'Gravar vs Grabar',
            BQ5: 'Formas Verbales',
            BQ6: 'Patrones de Ortograf√≠a'
        }
    },
    HAY: {
        title: 'üéØ Ah√≠/Hay/Ay',
        description: 'Diferencias entre Ah√≠, Hay, y Ay',
        subcategories: {
            HAY1: 'Hay (verbo haber)',
            HAY2: 'Ah√≠ (lugar)',
            HAY3: 'Ay (interjecci√≥n)',
            HAY4: 'Contextos formales',
            HAY5: 'Combinaciones complejas',
            HAY6: 'Pr√°ctica mixta'
        }
    },
    GJ: {
        title: 'üó£Ô∏è Pr√°ctica de G/J',
        description: 'Sonidos ge/gi vs je/ji y patrones',
        subcategories: {
            GJ1: 'ge/gi vs je/ji',
            GJ2: 'Verbos comunes',
            GJ3: 'Sustantivos frecuentes',
            GJ4: 'Palabras t√©cnicas',
            GJ5: 'Origen extranjero',
            GJ6: 'Pr√°ctica mixta'
        }
    }
};

// ==================== AIRTABLE INTEGRATION ====================

async function loadStudentFromAirtable(studentCode) {
    try {
        console.log('üìä Loading student from Airtable:', studentCode);
        
        const baseId = 'app7lGIzQKfZv6Wwg/tblvP0kQYopTdCIwn';
        const apiKey = 'pat0UHJ77pfMRbCos';
        
        if (!baseId || !apiKey) {
            alert('Por favor, ingresa tu Base ID y API Key de Airtable primero.');
            return null;
        }
        
        if (baseId === 'demo' || apiKey === 'demo') {
            // Use demo data if credentials aren't set
            return loadDemoStudentData(studentCode);
        }
        
        // Real Airtable API call
        const filterFormula = `student_id='${studentCode}'`;
        const url = `https://api.airtable.com/v0/${baseId}/Student?filterByFormula=${encodeURIComponent(filterFormula)}`;
        
        console.log('üîó API URL:', url);
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Airtable response:', data);
        
        if (data.records && data.records.length > 0) {
            return data.records[0].fields;
        } else {
            return null;
        }

    } catch (error) {
        console.error('‚ùå Error loading student from Airtable:', error);
        
        // Fallback to demo data if API fails
        console.log('üîÑ Falling back to demo data...');
        return loadDemoStudentData(studentCode);
    }
}

function loadDemoStudentData(studentCode) {
    console.log('üìö Using demo data for:', studentCode);
    
    const mockStudentData = {
        'JIM001': {
            student_id: 'Jim001',
            movies: 'Comedia, Fantas√≠a, Misterio/Crimen',
            sports: 'B√©isbol (ver), Tenis, Nataci√≥n',
            books: 'Misterio/Detectivesco, Romance, Ciencia Ficci√≥n, Aventura, No ficci√≥n',
            music: 'Rock, Cl√°sica, Latina, Salsa/Bachata',
            food: 'Tacos/Comida Mexicana, Italiana/Pasta, Comida Vegetariana, Comida Casera',
            hobbies: 'Arte/Dibujo, Fotograf√≠a, Cocinar/Hornear, Viajar, Coleccionar Cosas',
            h_nivel: 'intermedio',
            bv_nivel: 'principiante',
            hay_nivel: 'principiante',
            gj_nivel: 'intermedio',
            h_dificultades: 'haber vs a ver',
            bv_dificultades: 'formas verbales',
            hay_dificultades: 'hay vs ah√≠',
            gj_dificultades: 'ge/gi vs je/ji',
            enfoque_actual: 'H'
        },
        'JIM002': {
            student_id: 'Jim002',
            movies: 'Ciencia Ficci√≥n, Fantas√≠a, Documental',
            sports: 'Baloncesto/B√°squetbol (ver), B√©isbol (ver), Tenis',
            books: 'Terror/Suspenso, Biograf√≠a',
            music: 'Jazz, R&B, Latina',
            food: 'Mariscos, Comida Vegetariana, Helado/Postres',
            hobbies: 'Videojuegos, Cocinar/Hornear, Jardiner√≠a',
            h_nivel: 'avanzado',
            bv_nivel: 'intermedio',
            hay_nivel: 'avanzado',
            gj_nivel: 'intermedio',
            h_dificultades: 'casos especiales',
            bv_dificultades: 'gravar vs grabar',
            hay_dificultades: 'combinaciones complejas',
            gj_dificultades: 'palabras t√©cnicas',
            enfoque_actual: 'BV'
        },
        'JIM003': {
            student_id: 'Jim003',
            movies: 'Ciencia Ficci√≥n, Animadas/Caricaturas, Misterio/Crimen, Superh√©roes',
            sports: 'Tenis, Atletismo/Pista y Campo',
            books: 'Biograf√≠a, Poes√≠a, No ficci√≥n',
            music: 'Alternativa/Indie, K-Pop, Salsa/Bachata',
            food: 'Comida R√°pida, Comida Casera',
            hobbies: 'Redes Sociales, Ir de Compras, Viajar',
            h_nivel: 'principiante',
            bv_nivel: 'principiante',
            hay_nivel: 'principiante',
            gj_nivel: 'principiante',
            h_dificultades: 'conceptos b√°sicos',
            bv_dificultades: 'estaba vs estava',
            hay_dificultades: 'diferencias b√°sicas',
            gj_dificultades: 'sonidos b√°sicos',
            enfoque_actual: 'HAY'
        },
        'JIM004': {
            student_id: 'Jim004',
            movies: 'Comedia, Documental, Musical',
            sports: 'Tenis',
            books: 'Fantas√≠a, Aventura, Terror/Suspenso',
            music: 'Electr√≥nica/EDM, Cl√°sica, Jazz',
            food: 'Sushi/Comida Japonesa, Barbacoa/Parrillada, Mariscos, Helado/Postres',
            hobbies: 'Cocinar/Hornear',
            h_nivel: 'intermedio',
            bv_nivel: 'avanzado',
            hay_nivel: 'intermedio',
            gj_nivel: 'avanzado',
            h_dificultades: 'hasta vs asta',
            bv_dificultades: 'patrones avanzados',
            hay_dificultades: 'contextos formales',
            gj_dificultades: 'palabras extranjeras',
            enfoque_actual: 'GJ'
        },
        'JIM005': {
            student_id: 'Jim005',
            movies: 'Acci√≥n/Aventura, Drama',
            sports: 'F√∫tbol (jugar), Baloncesto/B√°squetbol (jugar)',
            books: 'Fantas√≠a, Terror/Suspenso',
            music: 'Jazz, Latina',
            food: 'Tacos/Comida Mexicana, Italiana/Pasta, Sushi/Comida Japonesa',
            hobbies: 'Fotograf√≠a, Tecnolog√≠a/Computadoras, Ir de Compras',
            h_nivel: 'avanzado',
            bv_nivel: 'avanzado',
            hay_nivel: 'avanzado',
            gj_nivel: 'avanzado',
            h_dificultades: 'pr√°ctica mixta',
            bv_dificultades: 'pr√°ctica mixta',
            hay_dificultades: 'pr√°ctica mixta',
            gj_dificultades: 'pr√°ctica mixta',
            enfoque_actual: 'H'
        },
        'JIM006': {
            student_id: 'Jim006',
            movies: 'Terror/Suspenso, Romance',
            sports: 'Nataci√≥n, F√∫tbol Americano',
            books: 'Ciencia Ficci√≥n, Poes√≠a',
            music: 'Rock, Hip-Hop/Rap',
            food: 'Comida Casera',
            hobbies: 'Coleccionar Cosas',
            h_nivel: 'principiante',
            bv_nivel: 'intermedio',
            hay_nivel: 'principiante',
            gj_nivel: 'principiante',
            h_dificultades: 'he vs e',
            bv_dificultades: 'tuvo vs tubo',
            hay_dificultades: 'ay interjecci√≥n',
            gj_dificultades: 'verbos comunes',
            enfoque_actual: 'BV'
        }
    };

    return mockStudentData[studentCode.toUpperCase()] || null;
}

async function saveSessionToAirtable(sessionData) {
    try {
        console.log('üíæ Saving session to Airtable:', sessionData);
        
        const baseId = document.getElementById('airtableBaseId').value.trim();
        const apiKey = document.getElementById('airtableApiKey').value.trim();
        
        if (!baseId || !apiKey || baseId === 'demo' || apiKey === 'demo') {
            console.log('üìù Demo mode - session data would be saved to Airtable');
            return { success: true, demo: true };
        }
        
        // Real Airtable API call to save session
        const response = await fetch(`https://api.airtable.com/v0/${baseId}/Sessions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                fields: sessionData
            })
        });
        
        if (!response.ok) {
            throw new Error(`Airtable save error: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Session saved to Airtable:', result);
        return { success: true, id: result.id };
        
    } catch (error) {
        console.error('‚ùå Error saving session to Airtable:', error);
        return { error: error.message };
    }
}

// ==================== MAIN STUDENT LOADING FUNCTION ====================

async function loadStudentProfile() {
    const studentCode = document.getElementById('studentCode').value.trim().toUpperCase();
    const loadBtn = document.getElementById('loadProfileBtn');
    
    console.log('üîç Attempting to load student:', studentCode);
    
    if (!studentCode) {
        alert('Por favor, ingresa un c√≥digo de estudiante v√°lido.');
        return;
    }
    
    // Show loading state
    loadBtn.innerHTML = 'üîÑ Cargando...';
    loadBtn.disabled = true;
    
    try {
        console.log('üì° Calling loadStudentFromAirtable...');
        // Load student data from Airtable
        studentData = await loadStudentFromAirtable(studentCode);
        
        console.log('üìä Student data received:', studentData);
        
        if (studentData) {
            console.log('‚úÖ Student found, displaying profile...');
            displayStudentProfile();
        } else {
            console.log('‚ùå Student not found');
            alert(`Estudiante "${studentCode}" no encontrado. Verifica el c√≥digo e intenta de nuevo.`);
        }
        
    } catch (error) {
        console.error('üí• Error loading student:', error);
        alert('Error cargando los datos del estudiante. Intenta de nuevo.');
    }
    
    // Reset button
    loadBtn.innerHTML = 'üîç Cargar Mi Perfil desde Airtable';
    loadBtn.disabled = false;
}

// Add event listener when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM loaded, setting up event listeners...');
    const loadBtn = document.getElementById('loadProfileBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', loadStudentProfile);
        console.log('‚úÖ Load button event listener attached');
    } else {
        console.error('‚ùå Load button not found!');
    }
});

function displayStudentProfile() {
    const profile = document.getElementById('studentProfile');
    const welcome = document.getElementById('studentWelcome');
    
    // Display student info
    welcome.textContent = studentData.student_id;
    
    // Display interests in separate spans
    document.getElementById('movieInterests').textContent = studentData.movies || 'No especificado';
    document.getElementById('sportsInterests').textContent = studentData.sports || 'No especificado';
    document.getElementById('musicInterests').textContent = studentData.music || 'No especificado';
    document.getElementById('foodInterests').textContent = studentData.food || 'No especificado';
    document.getElementById('hobbyInterests').textContent = studentData.hobbies || 'No especificado';
    
    createPracticeOptions();
    profile.style.display = 'block';
}

function createPracticeOptions() {
    const grid = document.getElementById('practiceGrid');
    
    grid.innerHTML = Object.keys(PRACTICE_TYPES).map(practiceId => {
        const practice = PRACTICE_TYPES[practiceId];
        const isRecommended = practiceId === studentData.enfoque_actual;
        const level = studentData[`${practiceId.toLowerCase()}_nivel`] || 'principiante';
        const difficulties = studentData[`${practiceId.toLowerCase()}_dificultades`] || '√Åreas b√°sicas';
        
        return `
            <div class="practice-card ${isRecommended ? 'recommended' : ''}" onclick="selectPractice('${practiceId}')">
                ${isRecommended ? '<div class="recommended-badge">Recomendado</div>' : ''}
                <div class="practice-title">${practice.title}</div>
                <div class="practice-level">${level}</div>
                <div class="practice-description">${practice.description}</div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <strong>Enfoque actual:</strong> ${difficulties}
                </div>
            </div>
        `;
    }).join('');
}

function selectPractice(practiceType) {
    selectedPracticeType = practiceType;
    
    // Update UI
    document.querySelectorAll('.practice-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    const clickedCard = event.target.closest('.practice-card');
    if (clickedCard) {
        clickedCard.classList.add('selected');
    }
    
    document.getElementById('startBtn').style.display = 'inline-block';
}

// ==================== ADAPTIVE PRACTICE SESSION ====================

async function startAdaptivePractice() {
    if (!selectedPracticeType) {
        alert('Por favor, selecciona un tipo de pr√°ctica.');
        return;
    }
    
    // Initialize session
    startTime = new Date();
    currentQuestion = 0;
    correctAnswers = 0;
    sessionData = [];
    practiceConfig = PRACTICE_TYPES[selectedPracticeType];
    
    // Show practice screen
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('practiceScreen').style.display = 'block';
    
    // Update display
    document.getElementById('practiceType').textContent = selectedPracticeType;
    
    // Start adaptive questioning
    await generateNextQuestion();
}

async function generateNextQuestion() {
    currentQuestion++;
    
    if (currentQuestion > totalQuestions) {
        endPractice();
        return;
    }
    
    // Reset attempt counter
    attemptCount = 0;
    
    // Select subcategory adaptively
    currentSubcategory = selectAdaptiveSubcategory();
    
    // Update UI
    document.getElementById('currentQuestion').textContent = currentQuestion;
    document.getElementById('subcategory').textContent = currentSubcategory;
    
    // Update progress bar
    const progress = ((currentQuestion - 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Generate question using AI
    await generateAIQuestion();
}

function selectAdaptiveSubcategory() {
    const practiceKey = selectedPracticeType.toLowerCase();
    const studentLevel = studentData[`${practiceKey}_nivel`];
    const difficulties = studentData[`${practiceKey}_dificultades`];
    const subcategories = Object.keys(practiceConfig.subcategories);
    
    // For HAY practice, ensure variety by cycling through subcategories
    if (selectedPracticeType === 'HAY') {
        // Cycle through HAY1, HAY2, HAY3 to ensure variety
        const hayOrder = ['HAY1', 'HAY2', 'HAY3', 'HAY4', 'HAY5', 'HAY6'];
        const currentIndex = (currentQuestion - 1) % hayOrder.length;
        return hayOrder[currentIndex];
    }
    
    // Focus on student's difficulty areas 60% of the time
    if (Math.random() < 0.6) {
        // Map difficulties to subcategories (simplified approach)
        const difficultyMap = {
            H: {
                'haber vs a ver': 'HQ1',
                'hecho vs echo': 'HQ2',
                'hasta vs asta': 'HQ3',
                'haya vs all√°': 'HQ4',
                'ha vs a': 'HQ5',
                'he vs e': 'HQ6',
                'conceptos b√°sicos': 'HQ1',
                'casos especiales': 'HQ4',
                'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)]
            },
            BV: {
                'estaba vs estava': 'BQ1',
                'botar vs votar': 'BQ2',
                'tuvo vs tubo': 'BQ3',
                'gravar vs grabar': 'BQ4',
                'formas verbales': 'BQ5',
                'patrones avanzados': 'BQ6',
                'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)]
            },
            HAY: {
                'hay vs ah√≠': 'HAY1',
                'diferencias b√°sicas': 'HAY1',
                'ay interjecci√≥n': 'HAY3',
                'contextos formales': 'HAY4',
                'combinaciones complejas': 'HAY5',
                'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)]
            },
            GJ: {
                'ge/gi vs je/ji': 'GJ1',
                'sonidos b√°sicos': 'GJ1',
                'verbos comunes': 'GJ2',
                'palabras t√©cnicas': 'GJ4',
                'palabras extranjeras': 'GJ5',
                'pr√°ctica mixta': subcategories[Math.floor(Math.random() * subcategories.length)]
            }
        };
        
        const mappedSubcat = difficultyMap[selectedPracticeType]?.[difficulties];
        if (mappedSubcat) {
            return mappedSubcat;
        }
    }
    
    // Otherwise, select based on level progression
    if (studentLevel === 'principiante') {
        return subcategories[Math.floor(Math.random() * 2)]; // First 2 subcategories
    } else if (studentLevel === 'intermedio') {
        return subcategories[Math.floor(Math.random() * 4)]; // First 4 subcategories
    } else {
        return subcategories[Math.floor(Math.random() * subcategories.length)]; // All subcategories
    }
}

async function generateAIQuestion() {
    const questionContent = document.getElementById('questionContent');
    const questionTitle = document.getElementById('questionTitle');
    
    // Show loading state
    questionContent.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>Generando pregunta personalizada con IA...</span>
        </div>
    `;
    
    try {
        // Create prompt based on student data and practice type
        const prompt = createQuestionPrompt(studentData, selectedPracticeType, currentSubcategory);
        
        // Call Claude API
        const response = await window.claude.complete(prompt);
        
        // Clean the response (remove markdown code blocks if present)
        let cleanResponse = response.replace(/```json\n?|\n?```/g, '').trim();
        
        // Parse the JSON response
        const questionData = JSON.parse(cleanResponse);
        
        // Validate the response structure
        if (!questionData.question || !questionData.options || typeof questionData.correct !== 'number') {
            throw new Error('Invalid question format from AI');
        }
        
        // Store current exercise
        currentExercise = questionData;
        
        // Display the question
        displayQuestion(questionData);
        
    } catch (error) {
        console.error('Error generating AI question:', error);
        
        // Fallback to a basic question
        const fallbackQuestion = createFallbackQuestion();
        currentExercise = fallbackQuestion;
        displayQuestion(fallbackQuestion);
    }
}

function createQuestionPrompt(studentData, practiceType, subcategory) {
    const practiceKey = practiceType.toLowerCase();
    const level = studentData[`${practiceKey}_nivel`];
    const difficulties = studentData[`${practiceKey}_dificultades`];
    
    // Get subcategory description
    const subcatDescription = PRACTICE_TYPES[practiceType].subcategories[subcategory];
    
    // Create specific prompts for each practice type
    let specificInstructions = '';
    let exampleOptions = [];
    
    switch(practiceType) {
        case 'H':
            specificInstructions = `Focus specifically on H spelling rules and silent H words. The question MUST involve choosing between words with H vs without H, such as:
            - haber vs a ver
            - hecho vs echo  
            - hasta vs asta
            - haya vs all√°
            - ha vs a
            - he vs e`;
            exampleOptions = ['["haber", "a ver"]', '["hecho", "echo"]', '["hasta", "asta"]'];
            break;
            
        case 'BV':
            specificInstructions = `Focus specifically on B vs V spelling distinctions. The question MUST involve choosing between words with B vs V, such as:
            - estaba vs estava (estava is incorrect)
            - botar vs votar
            - tuvo vs tubo  
            - gravar vs grabar
            - verb forms with B (estaba, hab√≠a, iba)
            - words with V (vivir, volver, venir)`;
            exampleOptions = ['["estaba", "estava"]', '["botar", "votar"]', '["tuvo", "tubo"]'];
            break;
            
        case 'HAY':
            specificInstructions = `Focus specifically on the distinction between HAY, AH√ç, and AY. Create variety by focusing on different subcategories:
            
            For ${subcategory}:
            - HAY1 (Hay verbo): Use "hay" as CORRECT answer - existence/presence
            - HAY2 (Ah√≠ lugar): Use "ah√≠" as CORRECT answer - location/place  
            - HAY3 (Ay interjecci√≥n): Use "ay" as CORRECT answer - exclamation/pain
            - HAY4-6: Mix all three options
            
            MEANINGS:
            - HAY = there is/are (verb haber) - "Hay comida en la mesa"
            - AH√ç = there (place/location) - "El libro est√° ah√≠" 
            - AY = ouch/oh (interjection/exclamation) - "¬°Ay, me duele!"
            
            IMPORTANT: Vary which word is correct based on the subcategory. Don't always make "hay" correct.`;
            
            // Force variety based on subcategory
            if (subcategory === 'HAY1') {
                exampleOptions = ['["hay", "ah√≠"]', '["hay", "ay"]'];
            } else if (subcategory === 'HAY2') {
                exampleOptions = ['["ah√≠", "hay"]', '["ah√≠", "ay"]'];
            } else if (subcategory === 'HAY3') {
                exampleOptions = ['["ay", "hay"]', '["ay", "ah√≠"]'];
            } else {
                exampleOptions = ['["hay", "ah√≠"]', '["ah√≠", "ay"]', '["ay", "hay"]'];
            }
            break;
            
        case 'GJ':
            specificInstructions = `Focus specifically on G vs J spelling distinctions. The question MUST involve choosing between words with G vs J, especially:
            - ge/gi vs je/ji sounds
            - words ending in -ger, -gir (usually G)
            - words ending in -jero, -jera (usually J)
            - common words like elegir vs elije, coger vs cojo`;
            exampleOptions = ['["elegir", "elijir"]', '["coger", "cojer"]', '["gente", "jente"]'];
            break;
    }

    return `You are creating a Spanish orthography practice question for a ${level} level student.

Student interests (use these to make the context engaging):
- Movies: ${studentData.movies}
- Sports: ${studentData.sports}
- Food: ${studentData.food}
- Music: ${studentData.music}
- Hobbies: ${studentData.hobbies}

PRACTICE TYPE: ${practiceType} - ${subcatDescription}
DIFFICULTY FOCUS: ${difficulties}
LEVEL: ${level}

${specificInstructions}

CRITICAL REQUIREMENTS:
1. The question MUST test ${practiceType} spelling rules specifically
2. Create a sentence using their interests that has a BLANK
3. The options must be actual ${practiceType} word pairs
4. One option must be correct, one incorrect
5. Use their interests (food, hobbies, etc.) to make the context engaging

Example option formats for ${practiceType}: ${exampleOptions.join(', ')}

Respond ONLY with valid JSON in this exact format:
{
  "question": "Complete the sentence with the correct word",
  "context": "Sentence with ___ blank that incorporates their interests",
  "options": ["correct_word", "incorrect_word"],
  "correct": 0,
  "explanation": "Brief explanation of the ${practiceType} rule"
}

DO NOT include markdown code blocks or any text outside the JSON.`;
}

function createFallbackQuestion() {
    // Accurate fallback questions for each practice type
    const fallbacks = {
        H: {
            question: "Complete la oraci√≥n con la palabra correcta:",
            context: "Voy _____ si hay alg√∫n mensaje para m√≠.",
            options: ["a ver", "haber"],
            correct: 0,
            explanation: "'A ver' significa 'let's see' o 'to see', mientras que 'haber' es un verbo auxiliar para tiempos perfectos."
        },
        BV: {
            question: "Selecciona la ortograf√≠a correcta:",
            context: "Ayer yo _____ estudiando en casa toda la tarde.",
            options: ["estaba", "estava"],
            correct: 0,
            explanation: "La forma correcta es 'estaba' con B. Las formas del verbo estar siempre van con B (estaba, estuve, estuvo)."
        },
        HAY: (() => {
            // Create variety for HAY practice fallbacks
            const hayFallbacks = [
                {
                    question: "Complete la oraci√≥n correctamente:",
                    context: "_____ muchos estudiantes en la clase hoy.",
                    options: ["Hay", "Ah√≠"],
                    correct: 0,
                    explanation: "'Hay' indica existencia (there is/are), mientras que 'ah√≠' indica lugar (there)."
                },
                {
                    question: "¬øCu√°l es la forma correcta?",
                    context: "El libro est√° _____ en la mesa.",
                    options: ["ah√≠", "hay"],
                    correct: 0,
                    explanation: "'Ah√≠' indica lugar o ubicaci√≥n (there), mientras que 'hay' indica existencia."
                },
                {
                    question: "Selecciona la opci√≥n apropiada:",
                    context: "¬°_____, me duele mucho la cabeza!",
                    options: ["Ay", "Hay"],
                    correct: 0,
                    explanation: "'Ay' es una interjecci√≥n que expresa dolor o sorpresa, mientras que 'hay' indica existencia."
                }
            ];
            
            // Use question number to cycle through different fallbacks
            const fallbackIndex = (currentQuestion - 1) % hayFallbacks.length;
            return hayFallbacks[fallbackIndex];
        })(),
        GJ: {
            question: "Selecciona la ortograf√≠a correcta:",
            context: "El profesor quiere que yo _____ la mejor opci√≥n.",
            options: ["elija", "elija"],
            correct: 0,
            explanation: "Las formas del verbo 'elegir' en subjuntivo van con J: elija, elijas, etc."
        }
    };
    
    // For HAY, execute the function to get variety
    if (selectedPracticeType === 'HAY') {
        return fallbacks.HAY;
    }
    
    return fallbacks[selectedPracticeType] || fallbacks.H;
}

function displayQuestion(questionData) {
    const questionContent = document.getElementById('questionContent');
    const questionTitle = document.getElementById('questionTitle');
    
    questionTitle.textContent = questionData.question;
    
    questionContent.innerHTML = `
        <div class="question-content">
            ${questionData.context}
        </div>
        <div class="options-grid">
            ${questionData.options.map((option, index) => `
                <button class="option-btn" onclick="selectAnswer(${index})">
                    ${option}
                </button>
            `).join('')}
        </div>
        <div id="feedback" style="display: none;"></div>
    `;
}

function selectAnswer(selectedIndex) {
    attemptCount++;
    const isCorrect = selectedIndex === currentExercise.correct;
    
    // Disable all option buttons
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.style.pointerEvents = 'none';
    });
    
    // Highlight the selected and correct answers
    const optionButtons = document.querySelectorAll('.option-btn');
    optionButtons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
    
    if (!isCorrect) {
        optionButtons[currentExercise.correct].classList.add('correct');
    }
    
    // Show feedback
    const feedback = document.getElementById('feedback');
    feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
    feedback.innerHTML = `
        <strong>${isCorrect ? '¬°Correcto!' : 'Incorrecto'}</strong><br>
        ${currentExercise.explanation}
    `;
    feedback.style.display = 'block';
    
    // Update stats
    if (isCorrect) {
        correctAnswers++;
        document.getElementById('correctCount').textContent = correctAnswers;
    }
    
    // Record the attempt
    sessionData.push({
        question_number: currentQuestion,
        practice_type: selectedPracticeType,
        subcategory: currentSubcategory,
        question: currentExercise.question,
        context: currentExercise.context,
        student_answer: currentExercise.options[selectedIndex],
        correct_answer: currentExercise.options[currentExercise.correct],
        is_correct: isCorrect,
        attempts: attemptCount,
        timestamp: new Date().toISOString()
    });
    
    // Continue to next question after a delay
    setTimeout(() => {
        generateNextQuestion();
    }, 3000);
}

function endPractice() {
    // Calculate final statistics
    const endTime = new Date();
    const sessionDuration = Math.round((endTime - startTime) / 1000); // in seconds
    const accuracy = Math.round((correctAnswers / currentQuestion) * 100);
    const categoriesPracticed = new Set(sessionData.map(q => q.subcategory)).size;
    
    // Prepare session summary for saving
    const sessionSummary = {
        student_id: studentData.student_id,
        practice_type: selectedPracticeType,
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        duration_seconds: sessionDuration,
        total_questions: currentQuestion,
        correct_answers: correctAnswers,
        accuracy_percentage: accuracy,
        categories_practiced: categoriesPracticed,
        questions_data: JSON.stringify(sessionData)
    };
    
    // Show results screen
    document.getElementById('practiceScreen').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'block';
    
    // Update results display
    document.getElementById('finalScore').textContent = currentQuestion;
    document.getElementById('finalAccuracy').textContent = accuracy + '%';
    document.getElementById('categoriesPracticed').textContent = categoriesPracticed;
    
    // Show progress details
    const progressDetails = document.getElementById('progressDetails');
    progressDetails.innerHTML = `
        <p><strong>‚è±Ô∏è Duraci√≥n:</strong> ${Math.floor(sessionDuration / 60)}:${(sessionDuration % 60).toString().padStart(2, '0')}</p>
        <p><strong>üéØ Tipo de Pr√°ctica:</strong> ${PRACTICE_TYPES[selectedPracticeType].title}</p>
        <p><strong>üìä Respuestas Correctas:</strong> ${correctAnswers} de ${currentQuestion}</p>
        <p><strong>üîç Categor√≠as Practicadas:</strong> ${Array.from(new Set(sessionData.map(q => q.subcategory))).join(', ')}</p>
    `;
    
    // Save session to Airtable
    saveSessionToAirtable(sessionSummary).then(result => {
        const saveStatus = document.getElementById('saveStatus');
        if (result.success) {
            saveStatus.innerHTML = '‚úÖ <strong>Resultados guardados exitosamente en Airtable</strong>';
            saveStatus.style.backgroundColor = '#d4edda';
            saveStatus.style.borderColor = '#28a745';
        } else {
            saveStatus.innerHTML = '‚ö†Ô∏è <strong>Error guardando en Airtable (en modo demo)</strong>';
            saveStatus.style.backgroundColor = '#fff3cd';
            saveStatus.style.borderColor = '#ffc107';
        }
    });
}

function restartPractice() {
    // Reset all variables
    currentQuestion = 0;
    correctAnswers = 0;
    sessionData = [];
    selectedPracticeType = '';
    currentSubcategory = '';
    currentExercise = null;
    
    // Show welcome screen
    document.getElementById('resultsScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'block';
    
    // Reset UI elements
    document.getElementById('currentQuestion').textContent = '1';
    document.getElementById('correctCount').textContent = '0';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('startBtn').style.display = 'none';
    
    // Clear selected practice cards
    document.querySelectorAll('.practice-card').forEach(card => {
        card.classList.remove('selected');
    });
}

// Initialize the app
console.log('üöÄ Sistema Adaptivo de Espa√±ol - GitHub Pages + Airtable version loaded');
console.log('üìä Ready to load student data and generate AI questions');
</script>
</body>
</html>
