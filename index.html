<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Adaptivo de Espa√±ol</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #667eea; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .screen { background: white; border-radius: 15px; padding: 30px; text-align: center; }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        .input-group { margin: 20px 0; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        .btn:hover { background: #2980b9; }
        .student-info { background: #e3f2fd; padding: 15px; margin: 15px 0; border-radius: 5px; text-align: left; }
        .practice-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .practice-card { background: #f8f9fa; border: 2px solid #ddd; border-radius: 10px; padding: 15px; cursor: pointer; text-align: left; }
        .practice-card:hover { border-color: #3498db; }
        .practice-card.selected { border-color: #28a745; background: #f8fff9; }
        .practice-card.recommended { border-color: #ff6b6b; background: #fff8f8; }
        .loading { text-align: center; padding: 20px; }
        .question-card { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .options-grid { display: grid; gap: 10px; margin: 20px 0; }
        .option-btn { padding: 12px; background: white; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; }
        .option-btn:hover { border-color: #3498db; }
        .option-btn.correct { background: #d4edda; border-color: #28a745; }
        .option-btn.incorrect { background: #f8d7da; border-color: #dc3545; }
        .feedback { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .feedback.correct { background: #d4edda; color: #155724; }
        .feedback.incorrect { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div class="container">
    <div class="screen" id="welcomeScreen">
        <h1>üéì Sistema Adaptivo de Espa√±ol</h1>
        <div class="input-group">
            <label for="studentCode">C√≥digo de Estudiante:</label>
            <input type="text" id="studentCode" placeholder="Ej: Jim001">
        </div>
        <button class="btn" id="loadProfileBtn">Cargar Perfil</button>
        <div id="studentProfile" style="display: none;">
            <div class="student-info">
                <h3>Bienvenido, <span id="studentWelcome"></span>!</h3>
                <p><strong>Pel√≠culas:</strong> <span id="movieInterests"></span></p>
                <p><strong>Deportes:</strong> <span id="sportsInterests"></span></p>
                <p><strong>M√∫sica:</strong> <span id="musicInterests"></span></p>
                <p><strong>Comida:</strong> <span id="foodInterests"></span></p>
                <p><strong>Pasatiempos:</strong> <span id="hobbyInterests"></span></p>
            </div>
            <div class="practice-grid" id="practiceGrid"></div>
            <button class="btn" onclick="startPractice()" id="startBtn" style="display: none;">Empezar Pr√°ctica</button>
        </div>
    </div>
    
    <div class="screen" id="practiceScreen" style="display: none;">
        <h2>Pregunta <span id="currentQuestion">1</span> de 5</h2>
        <div class="question-card" id="questionCard">
            <div class="loading">Generando pregunta...</div>
        </div>
        <button class="btn" onclick="endPractice()">Terminar</button>
    </div>
    
    <div class="screen" id="resultsScreen" style="display: none;">
        <h1>¬°Sesi√≥n Completada!</h1>
        <p>Respuestas correctas: <span id="finalScore">0</span></p>
        <button class="btn" onclick="restart()">Nueva Sesi√≥n</button>
    </div>
</div>

<script>
// Configuration
const AIRTABLE_BASE_ID = 'app7lGIzQKfZv6Wwg';
const AIRTABLE_API_KEY = 'pat0UHJ77pfMRbCos.66879c99abcdbcc82bf40f1bbe0531cf1118dbb69c4f2bea61cdf01f9d1872d3';
const CLAUDE_API_KEY = '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';

// Global variables
let studentData = null;
let currentQuestion = 0;
let correctAnswers = 0;
let selectedPracticeType = '';
let currentExercise = null;

const PRACTICE_TYPES = {
    H: { title: 'Pr√°ctica de H', description: 'Haber vs A ver, etc.' },
    BV: { title: 'Pr√°ctica de B/V', description: 'Botar vs Votar, etc.' },
    HAY: { title: 'Ah√≠/Hay/Ay', description: 'Diferencias entre las tres' },
    GJ: { title: 'Pr√°ctica de G/J', description: 'Sonidos ge/gi vs je/ji' }
};

// Load student data
async function loadStudentFromAirtable(studentCode) {
    try {
        const filterFormula = `student_id='${studentCode}'`;
        const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Student?filterByFormula=${encodeURIComponent(filterFormula)}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.records && data.records.length > 0) {
            return data.records[0].fields;
        } else {
            // Fallback demo data
            return {
                student_id: 'Jim001',
                movies: 'Comedia, Fantas√≠a',
                sports: 'B√©isbol, Tenis',
                music: 'Rock, Latina',
                food: 'Tacos, Pasta',
                hobbies: 'Arte, Fotograf√≠a',
                h_nivel: 'intermedio',
                h_dificultades: 'haber vs a ver',
                enfoque_actual: 'H'
            };
        }
    } catch (error) {
        console.error('Error:', error);
        return null;
    }
}

// Main load function
async function loadStudentProfile() {
    const studentCode = document.getElementById('studentCode').value.trim().toUpperCase();
    if (!studentCode) {
        alert('Ingresa un c√≥digo v√°lido');
        return;
    }
    
    const loadBtn = document.getElementById('loadProfileBtn');
    loadBtn.innerHTML = 'Cargando...';
    loadBtn.disabled = true;
    
    try {
        studentData = await loadStudentFromAirtable(studentCode);
        
        if (studentData) {
            displayStudentProfile();
        } else {
            alert('Estudiante no encontrado');
        }
    } catch (error) {
        alert('Error cargando datos');
    }
    
    loadBtn.innerHTML = 'Cargar Perfil';
    loadBtn.disabled = false;
}

// Display profile
function displayStudentProfile() {
    document.getElementById('studentWelcome').textContent = studentData.student_id;
    document.getElementById('movieInterests').textContent = studentData.movies || 'No especificado';
    document.getElementById('sportsInterests').textContent = studentData.sports || 'No especificado';
    document.getElementById('musicInterests').textContent = studentData.music || 'No especificado';
    document.getElementById('foodInterests').textContent = studentData.food || 'No especificado';
    document.getElementById('hobbyInterests').textContent = studentData.hobbies || 'No especificado';
    
    createPracticeOptions();
    document.getElementById('studentProfile').style.display = 'block';
}

// Create practice options
function createPracticeOptions() {
    const grid = document.getElementById('practiceGrid');
    grid.innerHTML = Object.keys(PRACTICE_TYPES).map(practiceId => {
        const practice = PRACTICE_TYPES[practiceId];
        const isRecommended = practiceId === studentData.enfoque_actual;
        return `
            <div class="practice-card ${isRecommended ? 'recommended' : ''}" onclick="selectPractice('${practiceId}')">
                <div style="font-weight: bold;">${practice.title}</div>
                <div style="font-size: 0.9em; color: #666;">${practice.description}</div>
                ${isRecommended ? '<div style="color: #ff6b6b; font-size: 0.8em;">Recomendado</div>' : ''}
            </div>
        `;
    }).join('');
}

// Select practice
function selectPractice(practiceType) {
    selectedPracticeType = practiceType;
    document.querySelectorAll('.practice-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.practice-card').classList.add('selected');
    document.getElementById('startBtn').style.display = 'inline-block';
}

// Start practice
function startPractice() {
    if (!selectedPracticeType) {
        alert('Selecciona una pr√°ctica');
        return;
    }
    
    currentQuestion = 0;
    correctAnswers = 0;
    
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('practiceScreen').style.display = 'block';
    
    generateNextQuestion();
}

// Generate question
async function generateNextQuestion() {
    currentQuestion++;
    
    if (currentQuestion > 5) {
        endPractice();
        return;
    }
    
    document.getElementById('currentQuestion').textContent = currentQuestion;
    document.getElementById('questionCard').innerHTML = '<div class="loading">Generando pregunta...</div>';
    
    try {
        const prompt = `Create a Spanish ${selectedPracticeType} practice question using these interests: ${studentData.movies}, ${studentData.sports}, ${studentData.food}. Return JSON: {"question": "text", "context": "sentence with blank", "options": ["option1", "option2"], "correct": 0, "explanation": "why"}`;
        
        const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": CLAUDE_API_KEY,
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-3-5-sonnet-20241022",
                max_tokens: 500,
                messages: [{ role: "user", content: prompt }]
            })
        });
        
        const data = await response.json();
        let cleanResponse = data.content[0].text.replace(/```json\n?|\n?```/g, '').trim();
        const questionData = JSON.parse(cleanResponse);
        
        currentExercise = questionData;
        displayQuestion(questionData);
        
    } catch (error) {
        console.error('Question generation error:', error);
        const fallback = {
            question: "Complete la oraci√≥n:",
            context: "Voy _____ si hay mensajes.",
            options: ["a ver", "haber"],
            correct: 0,
            explanation: "'A ver' significa 'to see'"
        };
        currentExercise = fallback;
        displayQuestion(fallback);
    }
}

// Display question
function displayQuestion(questionData) {
    document.getElementById('questionCard').innerHTML = `
        <h3>${questionData.question}</h3>
        <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 5px;">
            ${questionData.context}
        </div>
        <div class="options-grid">
            ${questionData.options.map((option, index) => `
                <button class="option-btn" onclick="selectAnswer(${index})">
                    ${option}
                </button>
            `).join('')}
        </div>
        <div id="feedback" style="display: none;"></div>
    `;
}

// Select answer
function selectAnswer(selectedIndex) {
    const isCorrect = selectedIndex === currentExercise.correct;
    
    document.querySelectorAll('.option-btn').forEach(btn => btn.style.pointerEvents = 'none');
    
    const optionButtons = document.querySelectorAll('.option-btn');
    optionButtons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
    
    if (!isCorrect) {
        optionButtons[currentExercise.correct].classList.add('correct');
    }
    
    const feedback = document.getElementById('feedback');
    feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
    feedback.innerHTML = `<strong>${isCorrect ? '¬°Correcto!' : 'Incorrecto'}</strong><br>${currentExercise.explanation}`;
    feedback.style.display = 'block';
    
    if (isCorrect) correctAnswers++;
    
    setTimeout(() => generateNextQuestion(), 2000);
}

// End practice
function endPractice() {
    document.getElementById('practiceScreen').style.display = 'none';
    document.getElementById('resultsScreen').style.display = 'block';
    document.getElementById('finalScore').textContent = `${correctAnswers} de ${currentQuestion - 1}`;
}

// Restart
function restart() {
    document.getElementById('resultsScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'block';
    document.getElementById('startBtn').style.display = 'none';
    document.querySelectorAll('.practice-card').forEach(card => card.classList.remove('selected'));
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loadProfileBtn').addEventListener('click', loadStudentProfile);
});

console.log('Sistema cargado correctamente');
</script>
</body>
</html>
